参照node-red脚本包，进行matter-server服务管理脚本包设计，分别设计和创建每个脚本文件，以下是基本要求：


# matter-server 服务管理脚本包设计

**Service ID:** `matter-server`


## 脚本文件清单及功能说明

| 脚本名               | 功能描述                          |
| ----------------- | ----------------------------- |
| `common_paths.sh` | 统一路径定义                        |
| `install.sh`      | 安装 matter-server 服务                |
| `start.sh`        | 启动 matter-server 服务                |
| `stop.sh`         | 停止 matter-server 服务，恢复 `.disabled` |
| `status.sh`       | 查询服务运行状态，依据 PID 和 5580 端口     |
| `update.sh`       | 升级 matter-server                   |
| `uninstall.sh`    | 卸载 matter-server 环境及配置             |
| `autocheck.sh`    | 单服务自检与性能监控                    |


## 操作命令及管理规范

### 1. 在 `isgservicemonitor` 下启停命令
| 操作    | 命令                                                                                |
| ----- | --------------------------------------------------------------------------------- |
| 启动    | `echo u > /data/data/com.termux/files/usr/var/service/matter-server/supervise/control` |
| 停止    | `echo d > /data/data/com.termux/files/usr/var/service/matter-server/supervise/control` |
| 禁用自启动 | `touch /data/data/com.termux/files/usr/var/service/matter-server/down`                 |
| 启用自启动 | `rm -f /data/data/com.termux/files/usr/var/service/matter-server/down`                 |

#### 2 安装服务
1） 使用如下方式安装
    proot-distro login ubuntu << 'EOF'
    commands
    'EOF'
2） 与依赖分开安装，避免由于依赖无法安装影响应用的安装

##### 2.1 安装系统依赖

```bash
apt update
apt install -y \
    "build-essential" "libssl-dev" "libffi-dev" "python3-dev" "git" "cmake" "ninja-build" "python3" "python3-pip" "python3-venv"
```

---

##### 2.2 创建 Python 虚拟环境

```bash
# -----------------------------------------------------------------------------
# 创建安装目录和Python虚拟环境
# -----------------------------------------------------------------------------
log "creating installation directory and Python virtual environment"
mqtt_report "isg/install/$SERVICE_ID/status" "{\"status\":\"installing\",\"message\":\"creating virtual environment\",\"timestamp\":$(date +%s)}"

if ! proot-distro login "$PROOT_DISTRO" -- bash -c "
    mkdir -p $MATTER_INSTALL_DIR
    cd $MATTER_INSTALL_DIR
    python3 -m venv venv
    source venv/bin/activate
    python3 -m pip install --upgrade pip setuptools wheel

"; then
    log "failed to create virtual environment"
    mqtt_report "isg/install/$SERVICE_ID/status" "{\"status\":\"failed\",\"message\":\"virtual environment creation failed\",\"timestamp\":$(date +%s)}"
    record_install_history "FAILED" "unknown"
    exit 1
fi

```

---

### ⬆️ 安装 Python 库依赖

```bash
if ! proot-distro login "$PROOT_DISTRO" -- bash -c "
    cd $MATTER_INSTALL_DIR
    source venv/bin/activate
    pip install cryptography
"; then
    log "failed to install basic Python dependencies"
    mqtt_report "isg/install/$SERVICE_ID/status" "{\"status\":\"failed\",\"message\":\"Python dependencies installation failed\",\"timestamp\":$(date +%s)}"
    record_install_history "FAILED" "unknown"
    exit 1
fi
```

---

### ⬆️ 安装 python-matter-server

```bash
if ! proot-distro login "$PROOT_DISTRO" -- bash -c "
    cd $MATTER_INSTALL_DIR
    source venv/bin/activate
    python3 -m pip install python-matter-server[server]
"; then
    log "failed to install python-matter-server"
    mqtt_report "isg/install/$SERVICE_ID/status" "{\"status\":\"failed\",\"message\":\"python-matter-server installation failed\",\"timestamp\":$(date +%s)}"
    record_install_history "FAILED" "unknown"
    exit 1
fi
```

---
### ⬆️ 获取版本

```bash
get_current_version() {
    proot-distro login "$PROOT_DISTRO" -- bash -c '
        if [ -f "'"$MATTER_ENV_DIR"'/bin/activate" ]; then
            source "'"$MATTER_ENV_DIR"'/bin/activate"
            pip show python-matter-server 2>/dev/null | awk -F": " "/^Version/ {print \$2}" || echo "unknown"
        else
            echo "unknown"
        fi
    ' 2>/dev/null || echo "unknown"
}
```

---
### ⬆️ 配置 config.yaml

```bash
# -----------------------------------------------------------------------------
# 生成初始配置文件
# -----------------------------------------------------------------------------
log "generating initial configuration"
mqtt_report "isg/install/$SERVICE_ID/status" "{\"status\":\"installing\",\"message\":\"generating initial configuration\",\"timestamp\":$(date +%s)}"

# 获取 MQTT 配置
load_mqtt_conf

proot-distro login "$PROOT_DISTRO" -- bash -c "
cat > $MATTER_CONFIG_FILE << EOF
mqtt:
  broker: 'mqtt://$MQTT_HOST:$MQTT_PORT'
  username: '$MQTT_USER'
  password: '$MQTT_PASS'

matter:
  listen_ip: '0.0.0.0'
  port: $MATTER_PORT
  storage_path: '$MATTER_INSTALL_DIR/storage'
  ssl:
    certfile: '$MATTER_INSTALL_DIR/certificate.pem'
    keyfile: '$MATTER_INSTALL_DIR/privatekey.pem'

logging:
  level: 'INFO'
  file: '$MATTER_INSTALL_DIR/matter-server.log'
EOF
"
```

---

### ⬆️ 生成自签名证书

```bash

# -----------------------------------------------------------------------------
# 生成 SSL 证书
# -----------------------------------------------------------------------------
log "generating SSL certificates"
mqtt_report "isg/install/$SERVICE_ID/status" "{\"status\":\"installing\",\"message\":\"generating SSL certificates\",\"timestamp\":$(date +%s)}"

proot-distro login "$PROOT_DISTRO" -- bash -c "
    cd $MATTER_INSTALL_DIR
    openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
        -keyout privatekey.pem \
        -out certificate.pem \
        -subj '/C=US/ST=State/L=City/O=Organization/CN=matter-server'
"
```

---


### 注册 servicemonitor 服务看护

```bash
# -----------------------------------------------------------------------------
# 注册 servicemonitor 服务看护
# -----------------------------------------------------------------------------
log "registering servicemonitor service"
mqtt_report "isg/install/$SERVICE_ID/status" "{\"status\":\"installing\",\"message\":\"registering servicemonitor service\",\"timestamp\":$(date +%s)}"

# 创建服务目录
mkdir -p "$SERVICE_CONTROL_DIR"

# 写入 run 启动脚本
cat << 'EOF' > "$RUN_FILE"
#!/data/data/com.termux/files/usr/bin/sh
# 启动 Matter Server
exec proot-distro login ubuntu -- bash -c '
    cd /opt/matter-server
    source /opt/matter-server/venv/bin/activate
    matter-server
'
EOF

# 赋予执行权限
chmod +x "$RUN_FILE"

# 创建 down 文件（初始状态不自启）
touch "$DOWN_FILE"
```

### 3 验证安装版本
```bash
get_current_version() {
    proot-distro login "$PROOT_DISTRO" -- bash -c '
        if [ -f "'"$MATTER_ENV_DIR"'/bin/activate" ]; then
            source "'"$MATTER_ENV_DIR"'/bin/activate"
            pip show python-matter-server 2>/dev/null | awk -F": " "/^Version/ {print \$2}" || echo "unknown"
        else
            echo "unknown"
        fi
    ' 2>/dev/null || echo "unknown"
}
```
### 4. MQTT上报
BASE_DIR="/data/data/com.termux/files/home/servicemanager"
CONFIG_FILE="$BASE_DIR/configuration.yaml"
MQTT broker信息来自于CONFIG_FILE里的mqtt

---

### 5. 路径定义
common_paths.sh 仅仅是统一路径定义的规范
不要加载统一路径定义，每个脚本使用独立参数，无需依赖common_paths.sh

### 6. autocheck要求
配置信息在/opt/matter-server/config.yaml里，只提取mqtt的配置信息和matter的listen_ip和port，其它信息不要提取

### 7. 备份还原要求
还原后需要重启应用，验证还原是否成功
执行bash restore.sh -c，直接执行初始化配置
备份，打包/root/.matter_server/目录下所有数据

### 8. 状态查询要求
bash status.sh, 只输出running/stopped
通过查版本号来确定程序是否安装，增加mqtt状态上报，install：true/false
bash status.sh --json 输出详细json内容

### 9. 升级命令
python3 -m pip install --upgrade python-matter-server[server]

### 10. 其它要求
关键步骤加上中文注释
Termux 专用的临时目录：
  - TERMUX_TMP_DIR="/data/data/com.termux/files/usr/tmp"
  - TEMP_DIR="$TERMUX_TMP_DIR/${SERVICE_ID}_temp"
