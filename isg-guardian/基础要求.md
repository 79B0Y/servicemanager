参照matter-server脚本包，进行isg-guardian服务管理脚本包设计，分别设计和创建每个脚本文件，以下是基本要求：


# isg-guardian 服务管理脚本包设计

**Service ID:** `isg-guardian`


## 脚本文件清单及功能说明

| 脚本名               | 功能描述                          |
| ----------------- | ----------------------------- |
| `common_paths.sh` | 统一路径定义                        |
| `install.sh`      | 安装 isg-guardian 服务                |
| `start.sh`        | 启动 isg-guardian 服务                |
| `stop.sh`         | 停止 isg-guardian 服务，恢复 `.disabled` |
| `status.sh`       | 查询服务运行状态，依据 PID 和 运行isg-guardian status查看状态     |
| `update.sh`       | 升级 isg-guardian                   |
| `uninstall.sh`    | 卸载 isg-guardian 环境及配置             |
| `autocheck.sh`    | 单服务自检与性能监控                    |


## 操作命令及管理规范

### 1. 在 `isgservicemonitor` 下启停命令
| 操作    | 命令                                                                                |
| ----- | --------------------------------------------------------------------------------- |
| 启动    | `echo u > /data/data/com.termux/files/usr/var/service/isg-guardian/supervise/control` |
| 停止    | `echo d > /data/data/com.termux/files/usr/var/service/isg-guardian/supervise/control` |
| 禁用自启动 | `touch /data/data/com.termux/files/usr/var/service/isg-guardian/down`                 |
| 启用自启动 | `rm -f /data/data/com.termux/files/usr/var/service/isg-guardian/down`                 |

#### 2 安装服务
1） 使用如下方式安装
    proot-distro login ubuntu << 'EOF'
    commands
    'EOF'
2） 与依赖分开安装，避免由于依赖无法安装影响应用的安装



##### 2.1 创建 Python 虚拟环境

```bash
# -----------------------------------------------------------------------------
# 创建安装目录和Python虚拟环境
# -----------------------------------------------------------------------------
log "creating installation directory and Python virtual environment"
mqtt_report "isg/install/$SERVICE_ID/status" "{\"status\":\"installing\",\"message\":\"creating virtual environment\",\"timestamp\":$(date +%s)}"

if ! proot-distro login "$PROOT_DISTRO" -- bash -c "
    cp -r /data/data/com.termux/files/home/servicemanager/isg-guardian/isg-guardian /root/
    cd /root/isg-guardian
    python3 -m venv venv
    source venv/bin/activate

"; then
    log "failed to create virtual environment"
    mqtt_report "isg/install/$SERVICE_ID/status" "{\"status\":\"failed\",\"message\":\"virtual environment creation failed\",\"timestamp\":$(date +%s)}"
    record_install_history "FAILED" "unknown"
    exit 1
fi

```

---

### ⬆️ 安装 python-matter-server

```bash
if ! proot-distro login "$PROOT_DISTRO" -- bash -c "
    cd /root/isg-guardian
    source venv/bin/activate
    bash install.sh
"; then
    log "failed to install basic Python dependencies"
    mqtt_report "isg/install/$SERVICE_ID/status" "{\"status\":\"failed\",\"message\":\"Python dependencies installation failed\",\"timestamp\":$(date +%s)}"
    record_install_history "FAILED" "unknown"
    exit 1
fi
```

---

### ⬆️ 获取版本

```bash
get_current_version() {
    proot-distro login "$PROOT_DISTRO" -- bash -c '
        if [ -f "/root/isg-guardian/venv/bin/activate" ]; then
            source /root/isg-guardian/venv/bin/activate"
            grep "VERSION = " isg-guardian 2>/dev/null | awk -F": " "/^Version/ {print \$2}" || echo "unknown"
        else
            echo "unknown"
        fi
    ' 2>/dev/null || echo "unknown"
}
```
### ⬆️ 获取进程
```bash
get_guardian_pid() {
    # 直接在 Termux 主环境查找 iSG App Guardian 进程
    local pid=$(pgrep -f 'iSG App Guardian' | head -n1 2>/dev/null || echo "")
    
    if [[ -n "$pid" ]]; then
        # 验证是否为 iSG App Guardian 相关进程
        local cmdline=$(cat /proc/$pid/cmdline 2>/dev/null | tr '\0' ' ' | grep -i 'iSG App Guardian' || echo "")
        if [[ -n "$cmdline" ]]; then
            echo "$pid"
            return 0
        fi
    fi
    
    return 1
}
```

---
### ⬆️ 配置config.yaml
文件在proot ubuntu的 /root/isg-guardian/config.yaml
需要读取CONFIG_FILE里的mqtt的用户名和密码
然后写入到config.yaml里的mqtt用户名和密码，示列
mqtt:
  enabled: true
  broker: "localhost"
  port: 1883
  username: "admin"              # 如果需要认证
  password: "admin"              # 如果需要认证
  topic_prefix: "isg"
  device_id: "isg_guardian"


### 注册 servicemonitor 服务看护

```bash
# -----------------------------------------------------------------------------
# 注册 servicemonitor 服务看护
# -----------------------------------------------------------------------------
log "registering servicemonitor service"
mqtt_report "isg/install/$SERVICE_ID/status" "{\"status\":\"installing\",\"message\":\"registering servicemonitor service\",\"timestamp\":$(date +%s)}"

# 创建服务目录
mkdir -p "$SERVICE_CONTROL_DIR"

# 写入 run 启动脚本
cat << 'EOF' > "$RUN_FILE"
#!/data/data/com.termux/files/usr/bin/sh
export PROCESS_TAG="${PROCESS_TAG}"

exec proot-distro login ubuntu -- bash -lc '
  set -e
  cd /root/isg-guardian

  # 如果有 venv 就激活
  if [ -f "venv/bin/activate" ]; then
    source venv/bin/activate
  fi

  # 补齐 PATH（非交互 shell 不会加载 ~/.profile，补上 ~/.local/bin）
  export PATH="$HOME/.local/bin:$PATH"

  # 优先用命令；没有就回退到 python -m
  if command -v isg-guardian >/dev/null 2>&1; then
    exec isg-guardian start
  else
    echo "[info] isg-guardian 不在 PATH，回退到 python -m..."
    exec python -m isg_guardian start
  fi
'
EOF

# 赋予执行权限
chmod +x "$RUN_FILE"

# 创建 down 文件（初始状态不自启）
touch "$DOWN_FILE"
```


### 4. MQTT上报
BASE_DIR="/data/data/com.termux/files/home/servicemanager"
CONFIG_FILE="$BASE_DIR/configuration.yaml"
MQTT broker信息来自于CONFIG_FILE里的mqtt

---

### 5. 路径定义
common_paths.sh 仅仅是统一路径定义的规范
不要加载统一路径定义，每个脚本使用独立参数，无需依赖common_paths.sh

### 6. autocheck要求
配置信息在/root/isg-guardian/config.yaml里，只提取mqtt的配置信息和ADB连接配置，其它信息不要提取

### 7. 备份还原要求
还原后需要重启应用，验证还原是否成功
执行bash restore.sh -c，直接执行初始化配置
备份，打包/root/.matter_server/目录下所有数据

### 8. 状态查询要求
bash status.sh, 只输出running/stopped
通过查版本号来确定程序是否安装，增加mqtt状态上报，install：true/false
bash status.sh --json 输出详细json内容

### 9. 升级命令
没有升级

### 10. 其它要求
关键步骤加上中文注释
Termux 专用的临时目录：
  - TERMUX_TMP_DIR="/data/data/com.termux/files/usr/tmp"
  - TEMP_DIR="$TERMUX_TMP_DIR/${SERVICE_ID}_temp"
