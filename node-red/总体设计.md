**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2025-07-15  
**ç»´æŠ¤è€…**: LinknLink æŠ€æœ¯å›¢é˜Ÿ

# Node-RED æœåŠ¡ç®¡ç†ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## 1. æœåŠ¡æ ‡è¯†
**Service ID**: `node-red`

## 2. è„šæœ¬åŠŸèƒ½æ¦‚è§ˆ

| è„šæœ¬åç§° | ä¸»è¦åŠŸèƒ½ | æè¿° |
|---------|---------|------|
| `install.sh` | å®‰è£… Node-RED æœåŠ¡ | åœ¨ proot Ubuntu ç¯å¢ƒä¸­å®‰è£… Node.jsã€pnpmã€ä¸‹è½½ Node-REDã€é…ç½®è¿è¡Œç¯å¢ƒ |
| `start.sh` | å¯åŠ¨æœåŠ¡ | é€šè¿‡ isgservicemonitor æ§åˆ¶æ–‡ä»¶å¯åŠ¨ Node-RED æœåŠ¡ï¼ŒåŒæ—¶å¯ç”¨æœåŠ¡è‡ªå¯åŠ¨ï¼Œç§»é™¤ down æ–‡ä»¶ rm -f "/data/data/com.termux/files/usr/var/service/node-red/down" |
| `stop.sh` | åœæ­¢æœåŠ¡ | åœæ­¢ Node-RED æœåŠ¡ï¼Œåˆ›å»º `.disabled` æ ‡å¿—æ–‡ä»¶ã€‚åŒæ—¶å…³é—­æœåŠ¡è‡ªå¯åŠ¨ï¼Œåˆ›å»º down æ–‡ä»¶ touch "/data/data/com.termux/files/usr/var/service/node-red/down" |
| `status.sh` | çŠ¶æ€æŸ¥è¯¢ | é€šè¿‡è¿›ç¨‹ PID å’Œç«¯å£ 1880 æ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œ HTTP æœåŠ¡å¯ç”¨æ€§ |
| `backup.sh` | é…ç½®å¤‡ä»½ | å¤‡ä»½ `/root/.node-red` ç›®å½•åˆ° `/sdcard/isgbackup/node-red/` |
| `restore.sh` | é…ç½®è¿˜åŸ | è¿˜åŸå¤‡ä»½æ–‡ä»¶æˆ–è‡ªåŠ¨ç”Ÿæˆé»˜è®¤æµé…ç½®æ–‡ä»¶ |
| `update.sh` | æœåŠ¡å‡çº§ | å‡çº§ Node-RED åˆ°æœ€æ–°ç‰ˆæœ¬ |
| `uninstall.sh` | å¸è½½æœåŠ¡ | å®Œå…¨å¸è½½ Node-RED ç¯å¢ƒå’Œé…ç½® |
| `autocheck.sh` | è‡ªæ£€ç›‘æ§ | å•æœåŠ¡è‡ªæ£€ã€æ€§èƒ½ç›‘æ§å’Œå¥åº·æ£€æŸ¥ |

## 3. MQTT çŠ¶æ€ä¸ŠæŠ¥

| è„šæœ¬åç§° | MQTT ä¸»é¢˜ | çŠ¶æ€å€¼ | è¯´æ˜ |
|---------|----------|--------|------|
| `install.sh` | `isg/install/node-red/status` | `installing`, `installed`, `failed` | å®‰è£…è¿›åº¦å’Œç»“æœ |
| `start.sh` | `isg/run/node-red/status` | `starting`, `success`, `failed` | å¯åŠ¨çŠ¶æ€ï¼ŒåŒ…å« down æ–‡ä»¶ç§»é™¤ä¿¡æ¯ "message":"remove down file to enable auto-start"|
| `stop.sh` | `isg/run/node-red/status` | `stopping`, `success`, `failed` | åœæ­¢çŠ¶æ€ï¼ŒåŒ…å« down æ–‡ä»¶åˆ›å»ºä¿¡æ¯ "message":"created down file to disable auto-start"|
| `status.sh` | `isg/status/node-red/status` | `running`, `starting`, `stopped` | å®æ—¶çŠ¶æ€ï¼ˆåŒ…å« PIDã€è¿è¡Œæ—¶é—´ã€HTTPçŠ¶æ€ï¼‰ |
| `backup.sh` | `isg/backup/node-red/status` | `backuping`, `success`, `skipped`, `failed` | å¤‡ä»½è¿›åº¦å’Œç»“æœ |
| `restore.sh` | `isg/restore/node-red/status` | `restoring`, `success`, `failed`, `skipped` | è¿˜åŸè¿›åº¦å’Œç»“æœ |
| `update.sh` | `isg/update/node-red/status` | `updating`, `success`, `failed` | å‡çº§è¿›åº¦å’Œç»“æœ |
| `uninstall.sh` | `isg/install/node-red/status` | `uninstalling`, `uninstalled` | å¸è½½è¿›åº¦ |
| `autocheck.sh` | `isg/autocheck/node-red/status` | { "status":"start/ healthy/ problem", "run":"running / stopped","config":{ "port": "1880","host": "0.0.0.0","httpAdminRoot": "","httpNodeRoot": "/" },"install":"start / installed / uninstall / skip","current_version":"4.0.9","latest_version":"4.0.9","update":"updated on 2025-07-15","message":"node-red running for xx hours","http_state":"online"} | è‡ªæ£€çŠ¶æ€ |
| `autocheck.sh` | `isg/autocheck/node-red/performance` | - | æ€§èƒ½æ•°æ®ï¼ˆCPUã€å†…å­˜ä½¿ç”¨ç‡ï¼‰ |
| `autocheck.sh` | `isg/autocheck/node-red/version` | - | ç‰ˆæœ¬ä¿¡æ¯ï¼ˆè„šæœ¬ç‰ˆæœ¬ã€æœåŠ¡ç‰ˆæœ¬ï¼‰ |

## 4. æœåŠ¡æ§åˆ¶å‘½ä»¤

### 4.1 isgservicemonitor æ§åˆ¶
- **å¯åŠ¨æœåŠ¡**: `echo u > /data/data/com.termux/files/usr/var/service/node-red/supervise/control`
- **åœæ­¢æœåŠ¡**: `echo d > /data/data/com.termux/files/usr/var/service/node-red/supervise/control`
- **ç¦ç”¨è‡ªå¯åŠ¨**: `touch /data/data/com.termux/files/usr/var/service/node-red/down`
- **å¯ç”¨è‡ªå¯åŠ¨**: `rm -f /data/data/com.termux/files/usr/var/service/node-red/down`

### 4.2 è¿›ç¨‹æ£€æµ‹æœºåˆ¶
- é€šè¿‡ 1880 ç«¯å£æ£€æµ‹: `netstat -tnlp | grep 1880`
- å·¥ä½œç›®å½•éªŒè¯: æ£€æŸ¥ `/proc/PID/cwd` æ˜¯å¦æŒ‡å‘ node-red ç›¸å…³è·¯å¾„
- HTTP æœåŠ¡çŠ¶æ€: ä½¿ç”¨ `nc -z localhost 1880` éªŒè¯ Web ç•Œé¢å¯ç”¨æ€§

## 5. å®‰è£…éƒ¨ç½²
é¦–å…ˆä»serviceupdate.yamlè¯»å–å®‰è£…éœ€è¦çš„ä¾èµ–ï¼Œå®‰è£…å¥½æ‰€æœ‰ä¾èµ–

### 5.1 ç³»ç»Ÿç¯å¢ƒå‡†å¤‡
```bash
# ç™»å½• proot-distro ubuntu å®¹å™¨
proot-distro login ubuntu
```

### 5.2 Node.js ç¯å¢ƒå®‰è£…
```bash
# å®‰è£… Node.js 20.x å’Œç›¸å…³å·¥å…·
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt-get install -y nodejs npm

# å®‰è£… pnpm åŒ…ç®¡ç†å™¨
npm install -g pnpm
```

### 5.3 Node-RED å®‰è£…
```bash
# å…¨å±€å®‰è£… Node-RED
pnpm add -g node-red@4.0.9

# éªŒè¯å®‰è£…ç‰ˆæœ¬
cat ~/.pnpm-global/global/5/node_modules/node-red/package.json | grep '"version"' | sed -E 's/.*"version": *"([^"]+)".*/\1/'
```

### 5.4 æœåŠ¡è¿è¡Œè„šæœ¬åˆ›å»º
```bash
# åˆ›å»ºæœåŠ¡ç›®å½•
mkdir -p $PREFIX/var/service/node-red/supervise
touch $PREFIX/var/service/node-red/down

# åˆ›å»ºè¿è¡Œè„šæœ¬
cat > $PREFIX/var/service/node-red/run << 'EOF'
#!/data/data/com.termux/files/usr/bin/sh
exec proot-distro login ubuntu -- bash -c "
export NODE_RED_HOME=/root/.node-red
mkdir -p \$NODE_RED_HOME
cd \$NODE_RED_HOME
exec /root/.pnpm-global/bin/node-red
" 2>&1
EOF

chmod +x $PREFIX/var/service/node-red/run
```

### 5.5 ç¯å¢ƒå˜é‡æ§åˆ¶
```bash
# å®‰è£…æŒ‡å®šç‰ˆæœ¬
TARGET_VERSION="4.0.9" bash install.sh

# ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬å®‰è£…ï¼ˆæ¨èï¼‰
bash install.sh
```

## 6. å‡çº§ç»´æŠ¤

### 6.1 ç‰ˆæœ¬å‡çº§æµç¨‹
é¦–å…ˆä»serviceupdate.yamlè¯»å–å®‰è£…éœ€è¦çš„ä¾èµ–ï¼Œå®‰è£…å¥½æ‰€æœ‰ä¾èµ–

```bash
# è¿›å…¥å®¹å™¨
proot-distro login ubuntu

# å‡çº§ Node-RED åˆ°æŒ‡å®šç‰ˆæœ¬
pnpm up -g node-red@4.0.9

# éªŒè¯æ–°ç‰ˆæœ¬
cat ~/.pnpm-global/global/5/node_modules/node-red/package.json | grep '"version"' | sed -E 's/.*"version": *"([^"]+)".*/\1/'
```

### 6.2 ç¯å¢ƒå˜é‡æ§åˆ¶
```bash
# å‡çº§åˆ°æŒ‡å®šç‰ˆæœ¬
TARGET_VERSION="4.0.10" bash update.sh

# å‡çº§æ—¶å®‰è£…æŒ‡å®šä¾èµ–
EXTRA_DEPS="node-red-contrib-dashboard@3.1.0" bash update.sh

# åŒæ—¶æŒ‡å®šç‰ˆæœ¬å’Œä¾èµ–
TARGET_VERSION="4.0.10" EXTRA_DEPS="node-red-contrib-dashboard@3.1.0" bash update.sh
```

### 6.3 é…ç½®ç®¡ç†
- **é…ç½®æ–‡ä»¶ä½ç½®**: `/root/.node-red/flows.json`, `/root/.node-red/settings.js`
- **å¤‡ä»½å­˜å‚¨ä½ç½®**: `/sdcard/isgbackup/node-red/`
- **é»˜è®¤é…ç½®ç”Ÿæˆ**: åŸºäºæ ‡å‡†æ¨¡æ¿è‡ªåŠ¨ç”Ÿæˆ

## 7. ç‰¹æ®ŠåŠŸèƒ½

### 7.1 Web ç•Œé¢è®¿é—®
- **è®¿é—®åœ°å€**: `http://localhost:1880`
- **ç®¡ç†ç•Œé¢**: Node-RED æµç¼–è¾‘å™¨
- **API ç«¯ç‚¹**: RESTful API å’Œ WebSocket è¿æ¥
- **çŠ¶æ€æ£€æŸ¥**: HTTP è¿æ¥æµ‹è¯•éªŒè¯æœåŠ¡å¯ç”¨æ€§

### 7.2 å¤‡ä»½ç­–ç•¥
- **è‡ªåŠ¨æ¸…ç†**: ä¿ç•™æœ€è¿‘ 3 ä¸ªå¤‡ä»½æ–‡ä»¶
- **å¤‡ä»½æ¡ä»¶**: ä»…åœ¨æœåŠ¡è¿è¡Œæ—¶æ‰§è¡Œå¤‡ä»½
- **æ ¼å¼æ”¯æŒ**: tar.gz å’Œ zip æ ¼å¼
- **æ™ºèƒ½è½¬æ¢**: ZIP æ–‡ä»¶è‡ªåŠ¨è½¬æ¢ä¸ºæ ‡å‡† tar.gz æ ¼å¼

### 7.3 è¿˜åŸæ§åˆ¶
```bash
# è‡ªåŠ¨è¿˜åŸæœ€æ–°å¤‡ä»½æ–‡ä»¶
bash restore.sh

# æŒ‡å®šç‰¹å®šå¤‡ä»½æ–‡ä»¶è¿˜åŸ
RESTORE_FILE="/sdcard/backup/my_node_red_flows.tar.gz" bash restore.sh

# æŒ‡å®š ZIP æ ¼å¼å¤‡ä»½æ–‡ä»¶ï¼ˆè‡ªåŠ¨è½¬æ¢ï¼‰
RESTORE_FILE="/sdcard/backup/node_red_backup.zip" bash restore.sh

# ä½¿ç”¨å¤–éƒ¨å¤‡ä»½æ–‡ä»¶
RESTORE_FILE="/storage/emulated/0/Download/flows-backup.zip" bash restore.sh
```

### 7.4 é”™è¯¯å¤„ç†
- **æœåŠ¡ä¾èµ–**: å¤‡ä»½å‰æ£€æŸ¥æœåŠ¡çŠ¶æ€
- **ç«¯å£å ç”¨**: æ£€æµ‹å‰ç¡®è®¤ç«¯å£å¯ç”¨æ€§
- **é…ç½®éªŒè¯**: ç”Ÿæˆé…ç½®å‰éªŒè¯ Node.js ç¯å¢ƒ
- **çŠ¶æ€ä¸ŠæŠ¥**: å®Œæ•´çš„ MQTT çŠ¶æ€ä¸ŠæŠ¥æœºåˆ¶

## 8. ç›‘æ§å‘Šè­¦

### 8.1 å¥åº·æ£€æŸ¥
- **è¿›ç¨‹ç›‘æ§**: PID å’Œè¿è¡Œæ—¶é—´æ£€æŸ¥
- **HTTPç›‘æ§**: Web ç•Œé¢å¯ç”¨æ€§éªŒè¯
- **æ€§èƒ½ç›‘æ§**: CPU å’Œå†…å­˜ä½¿ç”¨ç‡ç»Ÿè®¡
- **è‡ªåŠ¨æ¢å¤**: æœåŠ¡å¼‚å¸¸æ—¶è‡ªåŠ¨é‡å¯

### 8.2 ç‰ˆæœ¬ç®¡ç†
- **è„šæœ¬ç‰ˆæœ¬**: å½“å‰ v1.0.0
- **æœåŠ¡ç‰ˆæœ¬**: åŠ¨æ€è·å–å½“å‰å®‰è£…ç‰ˆæœ¬
- **æ›´æ–°æ£€æŸ¥**: å¯¹æ¯”æœ€æ–°å¯ç”¨ç‰ˆæœ¬
- **ä¾èµ–ç®¡ç†**: è‡ªåŠ¨å¤„ç†ç‰ˆæœ¬å‡çº§ä¾èµ–

## 9. æ–‡ä»¶ç»“æ„

### 9.1 è„šæœ¬ç›®å½•ç»“æ„
```
/data/data/com.termux/files/home/servicemanager/node-red/
â”œâ”€â”€ install.sh          # å®‰è£…è„šæœ¬
â”œâ”€â”€ start.sh            # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ stop.sh             # åœæ­¢è„šæœ¬
â”œâ”€â”€ status.sh           # çŠ¶æ€æŸ¥è¯¢è„šæœ¬
â”œâ”€â”€ backup.sh           # å¤‡ä»½è„šæœ¬
â”œâ”€â”€ restore.sh          # è¿˜åŸè„šæœ¬
â”œâ”€â”€ update.sh           # å‡çº§è„šæœ¬
â”œâ”€â”€ uninstall.sh        # å¸è½½è„šæœ¬
â”œâ”€â”€ autocheck.sh        # è‡ªæ£€è„šæœ¬
â”œâ”€â”€ common_paths.sh     # å…¬å…±è·¯å¾„å®šä¹‰
â”œâ”€â”€ VERSION             # ç‰ˆæœ¬ä¿¡æ¯
â””â”€â”€ logs/               # æ—¥å¿—ç›®å½•
    â”œâ”€â”€ install.log          # å®‰è£…æ—¥å¿—
    â”œâ”€â”€ start.log            # å¯åŠ¨æ—¥å¿—
    â”œâ”€â”€ stop.log             # åœæ­¢æ—¥å¿—
    â”œâ”€â”€ status.log           # çŠ¶æ€æŸ¥è¯¢æ—¥å¿—
    â”œâ”€â”€ backup.log           # å¤‡ä»½æ—¥å¿—
    â”œâ”€â”€ restore.log          # è¿˜åŸæ—¥å¿—
    â”œâ”€â”€ update.log           # å‡çº§æ—¥å¿—
    â”œâ”€â”€ uninstall.log        # å¸è½½æ—¥å¿—
    â”œâ”€â”€ autocheck.log        # è‡ªæ£€æ—¥å¿—
    â”œâ”€â”€ update_step_*.log    # ğŸ†• å‡çº§æ­¥éª¤è¯¦ç»†æ—¥å¿—
    â”œâ”€â”€ node_red_version.txt # ğŸ†• ç‰ˆæœ¬ä¿¡æ¯ä¸´æ—¶æ–‡ä»¶
    â””â”€â”€ restore_temp_*/      # ğŸ†• è¿˜åŸè¿‡ç¨‹ä¸´æ—¶ç›®å½•
```

### 9.2 å¤‡ä»½ç›®å½•ç»“æ„
```
/sdcard/isgbackup/node-red/
â”œâ”€â”€ .install_history                             # ğŸ†• å®‰è£…å†å²è®°å½•
â”œâ”€â”€ .update_history                              # ğŸ†• æ›´æ–°å†å²è®°å½•
â”œâ”€â”€ flows_default.json                          # é»˜è®¤æµé…ç½®æ¨¡æ¿
â”œâ”€â”€ node-red_backup_20250715-152030.tar.gz     # è‡ªåŠ¨å¤‡ä»½æ–‡ä»¶
â”œâ”€â”€ node-red_backup_20250715-151500.tar.gz     # ï¼ˆä¿ç•™æœ€æ–°3ä¸ªï¼‰
â””â”€â”€ node-red_backup_20250715-150900.tar.gz
```

### 9.3 æœåŠ¡è¿è¡Œç¯å¢ƒ
```
proot-distro ubuntu å®¹å™¨å†…:
/root/.node-red/
â”œâ”€â”€ flows.json              # æµé…ç½®æ–‡ä»¶
â”œâ”€â”€ settings.js             # Node-RED è®¾ç½®
â”œâ”€â”€ package.json            # é¡¹ç›®ä¾èµ–ï¼ˆå¦‚æœ‰ï¼‰
â”œâ”€â”€ node_modules/           # å®‰è£…çš„èŠ‚ç‚¹ï¼ˆå¦‚æœ‰ï¼‰
â””â”€â”€ .sessions.json          # ä¼šè¯ä¿¡æ¯

/root/.pnpm-global/
â”œâ”€â”€ bin/node-red            # Node-RED å¯æ‰§è¡Œæ–‡ä»¶
â””â”€â”€ global/5/node_modules/node-red/  # Node-RED æ ¸å¿ƒæ–‡ä»¶
    â””â”€â”€ package.json        # ç‰ˆæœ¬ä¿¡æ¯
```

## 10. æ•…éšœæ’æŸ¥

### 10.1 å¸¸è§é—®é¢˜
- **æœåŠ¡æ— æ³•å¯åŠ¨**: æ£€æŸ¥ Node.js ç¯å¢ƒå’Œç«¯å£å ç”¨
- **Webç•Œé¢æ— æ³•è®¿é—®**: éªŒè¯ 1880 ç«¯å£å’Œé˜²ç«å¢™è®¾ç½®
- **æµæ‰§è¡Œå¤±è´¥**: æ£€æŸ¥èŠ‚ç‚¹ä¾èµ–å’Œé…ç½®é”™è¯¯
- **é…ç½®æ–‡ä»¶æŸå**: ä½¿ç”¨ restore.sh é‡æ–°ç”Ÿæˆé…ç½®

### 10.2 æ—¥å¿—æŸ¥çœ‹
```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
bash status.sh

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
tail -f /data/data/com.termux/files/home/servicemanager/node-red/logs/autocheck.log

# æŸ¥çœ‹å‡çº§æ­¥éª¤æ—¥å¿—
ls /data/data/com.termux/files/home/servicemanager/node-red/logs/update_step_*.log

# æŸ¥çœ‹æœåŠ¡è¿è¡Œæ—¥å¿—ï¼ˆå®¹å™¨å†…ï¼‰
proot-distro login ubuntu
# Node-RED æ—¥å¿—è¾“å‡ºåˆ° isgservicemonitor ç®¡ç†çš„æ—¥å¿—ä¸­
```

### 10.3 æ‰‹åŠ¨æ“ä½œ
```bash
# æ‰‹åŠ¨å¯åŠ¨æœåŠ¡
bash start.sh

# å¼ºåˆ¶é‡å¯
bash stop.sh && sleep 5 && bash start.sh

# é‡æ–°ç”Ÿæˆé…ç½®
bash restore.sh

# æ‰‹åŠ¨è®¿é—® Node-REDï¼ˆå®¹å™¨å†…ï¼‰
proot-distro login ubuntu
cd /root/.node-red
/root/.pnpm-global/bin/node-red
```

## 11. ç¯å¢ƒå˜é‡å‚è€ƒ

### 11.1 å®‰è£…è„šæœ¬ç¯å¢ƒå˜é‡

| å˜é‡åç§° | é»˜è®¤å€¼ | è¯´æ˜ | ç¤ºä¾‹ |
|---------|-------|------|------|
| `TARGET_VERSION` | `4.0.9` | æŒ‡å®šå®‰è£…çš„ Node-RED ç‰ˆæœ¬ | `TARGET_VERSION="4.0.10" bash install.sh` |

### 11.2 å‡çº§è„šæœ¬ç¯å¢ƒå˜é‡

| å˜é‡åç§° | é»˜è®¤å€¼ | è¯´æ˜ | ç¤ºä¾‹ |
|---------|-------|------|------|
| `TARGET_VERSION` | - | æŒ‡å®šå‡çº§çš„ç›®æ ‡ç‰ˆæœ¬ï¼Œç•™ç©ºåˆ™å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ | `TARGET_VERSION="4.0.10" bash update.sh` |
| `EXTRA_DEPS` | - | å‡çº§æ—¶å®‰è£…çš„é¢å¤– Node-RED èŠ‚ç‚¹åŒ… | `EXTRA_DEPS="node-red-contrib-dashboard@3.1.0" bash update.sh` |

### 11.3 è¿˜åŸè„šæœ¬ç¯å¢ƒå˜é‡

| å˜é‡åç§° | é»˜è®¤å€¼ | è¯´æ˜ | ç¤ºä¾‹ |
|---------|-------|------|------|
| `RESTORE_FILE` | - | æŒ‡å®šè¦è¿˜åŸçš„å¤‡ä»½æ–‡ä»¶è·¯å¾„ | `RESTORE_FILE="/sdcard/backup/flows.zip" bash restore.sh` |

### 11.4 é€šç”¨ç¯å¢ƒå˜é‡

| å˜é‡åç§° | é»˜è®¤å€¼ | è¯´æ˜ | ç¤ºä¾‹ |
|---------|-------|------|------|
| `PROOT_DISTRO` | `ubuntu` | æŒ‡å®š proot-distro å®¹å™¨åç§° | `PROOT_DISTRO="debian" bash install.sh` |
| `NODE_RED_DATA_DIR` | `/root/.node-red` | Node-RED æ•°æ®ç›®å½•è·¯å¾„ | `NODE_RED_DATA_DIR="/custom/path" bash backup.sh` |
| `BACKUP_DIR` | `/sdcard/isgbackup/node-red` | å¤‡ä»½æ–‡ä»¶å­˜å‚¨ç›®å½• | `BACKUP_DIR="/storage/backups" bash backup.sh` |
| `KEEP_BACKUPS` | `3` | ä¿ç•™çš„å¤‡ä»½æ–‡ä»¶æ•°é‡ | `KEEP_BACKUPS="5" bash backup.sh` |

### 11.5 ä½¿ç”¨ç¤ºä¾‹

#### å®Œæ•´å®‰è£…æŒ‡å®šç‰ˆæœ¬
```bash
TARGET_VERSION="4.0.10" bash install.sh
```

#### å‡çº§åˆ°æŒ‡å®šç‰ˆæœ¬å¹¶å®‰è£…èŠ‚ç‚¹åŒ…
```bash
TARGET_VERSION="4.0.10" EXTRA_DEPS="node-red-contrib-dashboard@3.1.0 node-red-contrib-mqtt@1.0.0" bash update.sh
```

#### ä»æŒ‡å®šæ–‡ä»¶è¿˜åŸé…ç½®
```bash
RESTORE_FILE="/sdcard/Download/node_red_flows_20250715.zip" bash restore.sh
```

#### è‡ªå®šä¹‰å¤‡ä»½ç›®å½•å’Œä¿ç•™æ•°é‡
```bash
BACKUP_DIR="/storage/external/node_red_backups" KEEP_BACKUPS="5" bash backup.sh
```

#### ä½¿ç”¨ä¸åŒå®¹å™¨ç¯å¢ƒ
```bash
PROOT_DISTRO="debian" NODE_RED_DATA_DIR="/opt/node-red" bash install.sh
```

## 12. å†å²è®°å½•æ–‡ä»¶

### 12.1 æ–‡ä»¶ä½ç½®
- **å®‰è£…å†å²**: `/sdcard/isgbackup/node-red/.install_history`
- **æ›´æ–°å†å²**: `/sdcard/isgbackup/node-red/.update_history`

### 12.2 è®°å½•æ ¼å¼

#### å®‰è£…å†å²è®°å½•
```
2025-07-15 15:30:15 INSTALL SUCCESS 4.0.9
2025-07-15 16:45:22 UNINSTALL SUCCESS
2025-07-16 09:15:30 INSTALL SUCCESS 4.0.10
```

#### æ›´æ–°å†å²è®°å½•
```
2025-07-15 17:30:15 SUCCESS 4.0.8 -> 4.0.9
2025-07-15 18:45:22 FAILED 4.0.9 -> 4.0.10 (service start timeout)
2025-07-16 10:20:10 SUCCESS 4.0.9 -> 4.0.10
```

### 12.3 è®°å½•è§„åˆ™
- **æ—¶é—´æ ¼å¼**: `YYYY-MM-DD HH:MM:SS`
- **çŠ¶æ€ç±»å‹**: `INSTALL SUCCESS` / `UNINSTALL SUCCESS` / `SUCCESS` / `FAILED`
- **ç‰ˆæœ¬ä¿¡æ¯**: å®‰è£…è®°å½•å•ç‰ˆæœ¬ï¼Œæ›´æ–°è®°å½•ç‰ˆæœ¬å˜è¿
- **å¤±è´¥åŸå› **: æ›´æ–°å¤±è´¥æ—¶åŒ…å«å…·ä½“åŸå› 
- **æ–‡ä»¶æƒé™**: å­˜å‚¨åœ¨ `/sdcard` ç›®å½•ï¼ŒæŒä¹…åŒ–ä¿å­˜

## 13. Node-RED ç‰¹æœ‰é…ç½®

### 13.1 é»˜è®¤æµé…ç½®
```json
[
    {
        "id": "flow1",
        "label": "Flow 1",
        "nodes": [
            {
                "id": "node1",
                "type": "inject",
                "z": "flow1",
                "name": "Welcome",
                "payload": "Welcome to Node-RED!",
                "payloadType": "str",
                "x": 110,
                "y": 100,
                "wires": [["node2"]]
            },
            {
                "id": "node2",
                "type": "debug",
                "z": "flow1",
                "name": "Debug Output",
                "active": true,
                "complete": "payload",
                "x": 320,
                "y": 100,
                "wires": []
            }
        ]
    }
]
```

### 13.2 åŸºç¡€è®¾ç½®é…ç½®
```javascript
module.exports = {
    uiPort: process.env.PORT || 1880,
    uiHost: "0.0.0.0",
    httpAdminRoot: false,
    httpNodeRoot: "/",
    functionGlobalContext: {},
    exportGlobalContextKeys: false,
    logging: {
        console: {
            level: "info",
            metrics: false,
            audit: false
        }
    },
    editorTheme: {
        projects: {
            enabled: false
        }
    }
}
```

### 13.3 èŠ‚ç‚¹åŒ…ç®¡ç†
- **å®˜æ–¹èŠ‚ç‚¹**: éš Node-RED æ ¸å¿ƒå®‰è£…
- **ç¤¾åŒºèŠ‚ç‚¹**: é€šè¿‡ npm/pnpm å®‰è£…åˆ° `~/.node-red/node_modules/`
- **å¸¸ç”¨èŠ‚ç‚¹åŒ…**: dashboard, mqtt, modbus, influxdb ç­‰
- **ä¾èµ–ç®¡ç†**: package.json è‡ªåŠ¨ç»´æŠ¤ä¾èµ–å…³ç³»

## 14. ä¸ Zigbee2MQTT çš„å·®å¼‚å¯¹æ¯”

| ç‰¹æ€§ | Node-RED | Zigbee2MQTT |
|------|----------|-------------|
| **æœåŠ¡ç±»å‹** | HTTP Webåº”ç”¨ | MQTTç½‘å…³æœåŠ¡ |
| **ä¸»è¦ç«¯å£** | 1880 (HTTP) | 8080 (Web), MQTT |
| **é…ç½®å¤æ‚åº¦** | ä½ï¼ˆå¯è§†åŒ–ï¼‰ | ä¸­ï¼ˆéœ€ä¸²å£æ£€æµ‹ï¼‰ |
| **çŠ¶æ€æ£€æŸ¥** | HTTP + è¿›ç¨‹ | MQTTæ¡¥æ¥ + è¿›ç¨‹ |
| **æ•°æ®æ ¼å¼** | JSONæµé…ç½® | YAMLé…ç½® |
| **ç”¨æˆ·ç•Œé¢** | æµç¼–è¾‘å™¨ | ç®¡ç†ç•Œé¢ |
| **æ‰©å±•æ€§** | èŠ‚ç‚¹åŒ…ç”Ÿæ€ | Zigbeeè®¾å¤‡æ”¯æŒ |
| **å¤‡ä»½å†…å®¹** | æµ+è®¾ç½® | é…ç½®+æ•°æ®åº“ |
| **ä¾èµ–æ£€æµ‹** | Node.jsç¯å¢ƒ | ä¸²å£é€‚é…å™¨ |

---
