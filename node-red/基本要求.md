# node-red 服务管理脚本包设计

**Service ID:** `node-red`

## 脚本文件清单及功能说明

| 脚本名               | 功能描述                          |
| ----------------- | ----------------------------- |
| `common_paths.sh` | 统一路径定义                        |
| `install.sh`      | 安装 node-red 服务                |
| `start.sh`        | 启动 node-red 服务                |
| `stop.sh`         | 停止 node-red 服务，恢复 `.disabled` |
| `status.sh`       | 查询服务运行状态，依据 PID 和 1880 端口     |
| `update.sh`       | 升级 node-red                   |
| `uninstall.sh`    | 卸载 node-red 环境及配置             |
| `backup.sh`       | 备份用户数据                        |
| `restore.sh`      | 还原用户数据                        |
| `autocheck.sh`    | 单服务自检与性能监控                    |

---

## node-red 操作命令及管理规范

### 1. 在 `isgservicemonitor` 下启停命令

| 操作    | 命令                                                                                |
| ----- | --------------------------------------------------------------------------------- |
| 启动    | `echo u > /data/data/com.termux/files/usr/var/service/node-red/supervise/control` |
| 停止    | `echo d > /data/data/com.termux/files/usr/var/service/node-red/supervise/control` |
| 禁用自启动 | `touch /data/data/com.termux/files/usr/var/service/node-red/down`                 |
| 启用自启动 | `rm -f /data/data/com.termux/files/usr/var/service/node-red/down`                 |

---

### 2. node-red 安装步骤

#### 2.1 安装依赖

```bash
proot-distro login ubuntu << EOF
source ~/.bashrc
apt update && apt upgrade -y

# 检查是否已安装
node -v
npm -v
pnpm -v

# 若未安装，执行：
apt install -y nodejs
apt install -y npm
npm install -g pnpm
EOF
```

---

#### 2.2 安装 node-red 服务

```bash
proot-distro login ubuntu << EOF
source ~/.bashrc
mkdir -p /opt/node-red
cd /opt/node-red
pnpm add node-red@4.0.9

# 生成 package.json
echo '{
  "scripts": {
    "start": "node-red"
  },
  "dependencies": {
    "node-red": "4.0.9"
  }
}' > package.json
EOF
```

---

#### 2.3 注册 servicemonitor 服务看护

```bash
mkdir -p "/data/data/com.termux/files/usr/var/service/node-red/"

cat << 'EOF' > "/data/data/com.termux/files/usr/var/service/node-red/run"
#!/data/data/com.termux/files/usr/bin/sh
exec proot-distro login ubuntu << EOF
npm --prefix /opt/node-red/ start
EOF
2>&1
EOF

chmod +x /data/data/com.termux/files/usr/var/service/node-red/run

# 禁用自启动
touch /data/data/com.termux/files/usr/var/service/node-red/down
```

---

#### 2.4 验证安装版本

```bash
proot-distro login ubuntu << EOF 2>/dev/null
cat /opt/node-red/package.json | grep '"node-red"' | grep -v "start" | sed -E 's/.*"node-red": *"([^"]+)".*/\1/'
EOF
```

---

### 3. node-red 升级命令

```bash
proot-distro login ubuntu << EOF
cd /opt/node-red
pnpm up node-red@4.0.9   # 4.0.9 为升级版本号
EOF
```
