**ISG Android Controller 使用文档**

**环境要求**
- 运行环境: Termux + Proot Ubuntu（推荐）或任何能运行 `adb`/Python 的 Linux。
- 依赖: `adb`, `mosquitto-clients`, `redis-server`, `python3-venv`, `pip`。

**安装**
- 一键安装: `bash install.sh`
  - 可传环境变量覆盖配置: `MQTT_HOST=192.168.1.10 ADB_HOST=192.168.1.20 START_NO
W=0 bash install.sh`
  - 安装 CLI 到 `~/.local/bin/isg-android-control`（请确保在 `PATH`）
- 纯 Termux 或无 `apt-get`: `bash scripts/setup.sh`
- 开机自启（Termux:Boot）: `bash scripts/install_termux_boot.sh`

**配置**
- `configs/device.yaml`: `adb_host/port` 或 `adb_serial`；iSG 无电池/蜂窝，保持 
`has_battery: false`, `has_cellular: false`。
- `configs/mqtt.yaml`: `host/port/username/password/discovery_prefix/base_topic`
。
- `configs/apps.yaml`: 友好名→包名映射；`visible` 控制 HA 前端下拉选项。
- `.env`（可选，支持覆盖）:
  - `MQTT_HOST/PORT/USERNAME/PASSWORD`, `ADB_HOST/PORT/SERIAL`, `REDIS_URL`, `SC
REENSHOTS_DIR` 等。

**启动与管理**
- 启动: `isg-android-control start`
- 停止/状态/日志: `isg-android-control stop | status | logs`
- ADB 连接提示（一次性）:
  - 设备端启用开发者选项 → `adb tcpip 5555` → `adb connect <device-ip>:5555`

**REST API（默认端口 8000）**
- 健康检查: `GET /health`
- 导航/音量/亮度/屏幕: `POST /nav/{action}`, `/volume/{direction}`, `/brightness
?value=128`, `/screen/{action}`
- 应用: `POST /apps/{action}/{name}`（`start|stop|switch`）
- 系统与截图: `GET /metrics`, `POST /screenshot`
- 应用扩展: `GET /apps`（映射）, `/apps/installed`, `/apps/foreground`, `/apps/s
tatus`, `/apps/options`
- HA 刷新/配置: `POST /ha/refresh`, `POST /ha/options`（更新 `visible` 并立即生
效）

**MQTT 与 Home Assistant**
- 自动发现: 使用 `mqtt.yaml` 的 `discovery_prefix` 和 `base_topic`。
- 命令主题: `<base>/cmd`
  - 示例: `nav:up`, `screen:on`, `brightness:128`, `brightness_pct:50`, `app:s
tch:Spotify`, `screenshot`
- 选择器: `<base>/app_select/set`（payload 为友好名）；状态 `<base>/app_select/s
tate`；属性 `<base>/app_select/attributes`（包含 options/mapping/installed/activ
e）
- 状态: `<base>/state`（CPU/内存/网络/屏幕/亮度），`<base>/active_app`（前台包名
）

**文件与目录**
- 日志: `var/log/isg-android-control.log`
- PID: `var/run/isg-android-control.pid`
- 截图: `var/screenshots/`（最多保留 3 张）

**网络与固定 IP**
- 静态 IP 辅助脚本: `bash scripts/set_static_ip.sh <iface> <ip> <cidr> <gateway>
`

**故障排查**
- 无法连接 ADB: 确认 `adb tcpip 5555` 且设备与服务在同一网段；或设置 `adb_serial
`。
- HA 实体未出现: 检查 MQTT Broker 与发现前缀；尝试 `POST /ha/refresh`；清理旧发
现保留消息。
- MQTT 命令无效: 确认命令主题与 payload；查看 `logs`。
