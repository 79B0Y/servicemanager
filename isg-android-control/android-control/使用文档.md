**ISG Android Controller 使用文档**

**环境要求**
- 运行环境: Termux + Proot Ubuntu（推荐）或任何能运行 `adb`/Python 的 Linux。
- 依赖: `adb`, `mosquitto-clients`, `redis-server`, `python3-venv`, `pip`。

**安装**
- 一键安装: `bash install.sh`
  - 可传环境变量覆盖配置: `MQTT_HOST=192.168.1.10 ADB_HOST=192.168.1.20 START_NO
W=0 bash install.sh`
  - 安装 CLI 到 `~/.local/bin/isg-android-control`（请确保在 `PATH`）
- 纯 Termux 或无 `apt-get`: `bash scripts/setup.sh`
- 开机自启（Termux:Boot）: `bash scripts/install_termux_boot.sh`

**配置**
- `configs/device.yaml`: `adb_host/port` 或 `adb_serial`；iSG 无电池/蜂窝，保持 `has_battery: false`, `has_cellular: false`。
  - `screenshot_interval`: 截图间隔（秒），默认 10。
  - `screenshot_keep`: 保留截图数量，默认 3。
  - `camera_enabled`: 是否启用 MQTT 摄像头，默认 true。
  - `camera_max_bytes`: 超过此大小则不发布到 MQTT（字节），默认 600000。
  - `camera_retain`: MQTT 消息是否保留，默认 false。
  - `camera_compress`: 是否压缩图像，默认 true。
  - `camera_format`: 图像格式 `jpeg` 或 `png`，默认 `jpeg`。
  - `camera_quality`: JPEG 压缩质量，默认 70。
  - `camera_max_width`: 发送图像的最大宽度，默认不限制。
  - `camera_max_height`: 发送图像的最大高度，默认不限制。
  - `device_id`: 设备唯一 ID，默认 `isg_android_controller`。
  - `device_name`: 设备名称，默认 `ISG Android Controller`。
  - `app_watch_enabled`: 是否监控前台应用，默认 true。
  - `app_poll_interval`: 前台应用轮询间隔（秒），默认 2。
  - `configs/mqtt.yaml`: `host/port/username/password/discovery_prefix/base_topic`。
  - `configs/apps.yaml`: 友好名→包名映射；`visible` 控制 HA 前端下拉选项。
  - `.env`（可选，支持覆盖）:
  - `MQTT_HOST/PORT/USERNAME/PASSWORD`, `ADB_HOST/PORT/SERIAL`, `REDIS_URL`, `SCREENSHOTS_DIR` 等。
  - `configs/api.yaml`（可选）: `host/port`。
  - `.env` 或环境变量（可选，支持覆盖 `configs/*` 默认值）:
  - `MQTT_HOST/PORT/USERNAME/PASSWORD`, `API_HOST/PORT`, `ADB_HOST/PORT/SERIAL`
  - `DEVICE_ID`, `DEVICE_NAME`, `CAMERA_*`（如 `CAMERA_MAX_BYTES`, `CAMERA_FORMAT` 等）
  - `REDIS_URL`, `SCREENSHOTS_DIR`, `LOGS_DIR`, `RUN_DIR` 等。
默认值可通过 `.env` 或环境变量覆盖，优先级高于 `configs/*`。
    
**启动与管理**
- 启动（前台）: `isg-android-control start`
- 后台运行: `isg-android-control daemon`（或 `start-daemon`）
- 查看版本: `isg-android-control version`
- 停止/状态/日志: `isg-android-control stop | status | logs`
- `start` 与 `daemon` 区别：前者前台运行，后者后台运行并写入 PID 文件。
- ADB 连接提示（一次性）:
  - 设备端启用开发者选项 → `adb tcpip 5555` → `adb connect <device-ip>:5555`

**REST API（默认端口 8000）**
- 健康检查: `GET /health`
- 导航/音量/亮度/屏幕: `POST /nav/{action}`, `/volume/{direction}`, `/brightness
?value=128`, `/screen/{action}`
- 应用: `POST /apps/{action}/{name}`（`start|stop|switch`）
- 系统与截图: `GET /metrics`, `POST /screenshot`
- 应用扩展: `GET /apps`（映射）, `/apps/installed`, `/apps/foreground`, `/apps/s
tatus`, `/apps/options`
- HA 刷新/配置: `POST /ha/refresh`, `POST /ha/options`（更新 `visible` 并立即生
效）

**MQTT 与 Home Assistant**
- 自动发现: 使用 `mqtt.yaml` 的 `discovery_prefix` 和 `base_topic`。
- 命令主题: `<base>/cmd`
  - 示例: `nav:up`, `screen:on`, `brightness:128`, `brightness_pct:50`, `app:s
tch:Spotify`, `screenshot`
- 选择器: `<base>/app_select/set`（payload 为友好名）；状态 `<base>/app_select/s
tate`；属性 `<base>/app_select/attributes`（包含 options/mapping/installed/activ
e）
- 状态: `<base>/state`（CPU/内存/网络/屏幕/亮度），`<base>/active_app`（前台包名
）

**文件与目录**
- 日志: `var/log/isg-android-control.log`
- PID: `var/run/isg-android-control.pid`
- 截图: `var/screenshots/`（最多保留 3 张）

**网络与固定 IP**
- 静态 IP 辅助脚本: `bash scripts/set_static_ip.sh <iface> <ip> <cidr> <gateway>
`

**故障排查**
- 无法连接 ADB: 确认 `adb tcpip 5555` 且设备与服务在同一网段；或设置 `adb_serial
`。
- HA 实体未出现: 检查 MQTT Broker 与发现前缀；尝试 `POST /ha/refresh`；清理旧发
现保留消息。
- MQTT 命令无效: 确认命令主题与 payload；查看 `logs`。
- 

**ADB**
adb shell dumpsys display | grep mScreenState


# 按档位设置（music 流）
INDEX=12 STREAM=music python3 adb_volume_pct.py

# 按百分比设置 + 上报到 HA
PCT=40 REPORT=1 REPORT_HA=1 BASE_TOPIC=isg/android MQTT_HOST=127.0.0.1 python3 adb_volume_pct.py


查看端口 8000 的进程：
sudo lsof -i :8000
发送停止命令是主动杀掉进程
sudo kill -9 pid

