# Mosquitto 服务管理系统设计文档

**文档版本**: v1.0.0  
**最后更新**: 2025-07-17  
**维护者**: LinknLink 技术团队

## 1. 服务标识与定位

### 1.1 服务基本信息
- **Service ID**: `mosquitto`
- **显示名称**: Mosquitto MQTT Broker
- **版本**: v1.0.0
- **服务类型**: 基础设施服务

### 1.2 服务定位与架构
- **服务定位**: servicemanager 生态系统的核心 MQTT Broker
- **基础设施角色**: 作为整个 servicemanager 体系的消息中间件
- **服务依赖关系**: 其他服务（如 Zigbee2MQTT、Home Assistant）通过标准接口使用 Mosquitto 提供的 MQTT 通信能力
- **配置中心化**: 统一管理 MQTT 连接信息，避免各服务独立配置

### 1.3 服务启动优先级
1. **第一优先级**: Mosquitto (作为基础设施)
2. **第二优先级**: 数据库服务 (如 MySQL)
3. **第三优先级**: 应用服务 (如 Zigbee2MQTT、Home Assistant)

## 2. 脚本功能概览

| 脚本名称 | 主要功能 | 描述 |
|---------|---------|------|
| `common_paths.sh` | 统一路径定义和公共函数 | 所有脚本的公共函数库和路径定义 |
| `install.sh` | 安装 Mosquitto 服务 | 在 Termux 环境中安装 Mosquitto、生成配置文件、创建用户密码 |
| `start.sh` | 启动服务 | 通过 isgservicemonitor 控制文件启动 Mosquitto 服务，移除 down 文件 |
| `stop.sh` | 停止服务 | 停止 Mosquitto 服务，创建 `.disabled` 标志文件和 down 文件 |
| `status.sh` | 状态查询 | 检查进程 PID、端口监听状态(1883/9001)、配置文件有效性 |
| `backup.sh` | 配置备份 | 备份配置文件、密码文件、持久化数据到 `/sdcard/isgbackup/mosquitto/` |
| `restore.sh` | 配置还原 | 还原备份文件或自动生成默认配置文件，支持 tar.gz 和 zip 格式 |
| `update.sh` | 服务升级 | 升级 Mosquitto 到最新版本，处理升级依赖 |
| `uninstall.sh` | 卸载服务 | 完全卸载 Mosquitto 环境和配置 |
| `autocheck.sh` | 自检监控 | 单服务自检、性能监控、健康检查和环境变量驱动的配置管理 |

## 3. 配置管理架构

### 3.1 三层配置结构
```
serviceupdate.json (配置源)
    ├── services[].config {...}              # 统一配置格式
              ↓ 同步更新
configuration.yaml (全局配置)
    └── mqtt: {...}                          # 全局 MQTT 服务信息
              ↓ 读取使用
其他服务 (消费者)
    └── load_mqtt_conf() 函数               # 标准化读取接口
```

### 3.2 serviceupdate.json 统一配置结构
```json
{
  "services": [
    {
      "id": "mosquitto",
      "display_name": "Mosquitto MQTT Broker",
      "enabled": true,
      "current_script_version": "1.0.0",
      "latest_script_version": "1.0.0",
      "current_service_version": "2.0.18",
      "latest_service_version": "2.0.18",
      "upgrade_dependencies": [],
      "install_dependencies": [],
      "config": {
        "port": "1883",
        "bind_address": "0.0.0.0",
        "allow_anonymous": "false",
        "password_file": "/data/data/com.termux/files/usr/etc/mosquitto/passwd",
        "log_dest": "file",
        "persistence": "true",
        "username": "admin",
        "password": "admin123",
        "websocket_port": "9001",
        "broker_service": "mosquitto",
        "max_connections": "100",
        "max_inflight_messages": "20",
        "max_queued_messages": "100",
        "log_types": ["error", "warning", "notice", "information"],
        "persistence_location": "/data/data/com.termux/files/usr/var/lib/mosquitto/"
      },
      "notes": "MQTT broker service for servicemanager ecosystem"
    }
  ]
}
```

### 3.3 配置字段映射关系

| serviceupdate.json 字段 | configuration.yaml 字段 | mosquitto.conf 配置项 | autocheck状态消息字段 |
|------------------------|-------------------------|----------------------|---------------------|
| `config.port` | `mqtt.port` | `port 1883` | `config.port` |
| `config.bind_address` | `mqtt.host` | `bind_address 0.0.0.0` | `config.bind_address` |
| `config.username` | `mqtt.username` | N/A (存储在passwd文件) | N/A (敏感信息) |
| `config.password` | `mqtt.password` | N/A (存储在passwd文件) | N/A (敏感信息) |
| `config.websocket_port` | `mqtt.websocket_port` | `listener 9001` + `protocol websockets` | N/A |
| `config.broker_service` | `mqtt.broker_service` | N/A (固定为mosquitto) | N/A |
| `config.allow_anonymous` | N/A | `allow_anonymous false` | `config.allow_anonymous` |
| `config.password_file` | N/A | `password_file /path/to/passwd` | `config.password_file` |
| `config.persistence` | N/A | `persistence true` | `config.persistence` |
| `config.log_dest` | N/A | `log_dest file` | `config.log_dest` |
| `config.max_connections` | N/A | `max_connections 100` | N/A |

### 3.4 环境变量驱动的配置管理

#### 3.4.1 触发方式
通过环境变量 `MQTT_USERNAME` 和 `MQTT_PASSWORD` 驱动配置更新：

```bash
# 方式1: 直接调用环境变量更新
MQTT_USERNAME="newuser" MQTT_PASSWORD="newpass" bash autocheck.sh --update-env-config

# 方式2: 在正常autocheck中自动检测
MQTT_USERNAME="newuser" MQTT_PASSWORD="newpass" bash autocheck.sh

# 方式3: App设置环境变量后调用
export MQTT_USERNAME="newuser"
export MQTT_PASSWORD="newpass"
bash autocheck.sh
```

#### 3.4.2 四步更新流程

**步骤1: 更新serviceupdate.json配置**
```bash
update_serviceupdate_config() {
    # 使用jq更新serviceupdate.json中的username和password字段
    jq "(.services[] | select(.id==\"mosquitto\") | .config.username) = \"$new_username\" | 
        (.services[] | select(.id==\"mosquitto\") | .config.password) = \"$new_password\""
}
```

**步骤2: 对比并更新本地服务配置**
```bash
compare_serviceupdate_with_local_config() {
    # 对比serviceupdate.json配置与mosquitto.conf、passwd文件
    # 如果不同则调用：
    # - generate_mosquitto_config_from_serviceupdate()
    # - update_users_from_serviceupdate()
}
```

**步骤3: 对比并更新全局配置**
```bash
compare_local_with_global_config() {
    # 对比本地配置与configuration.yaml中的mqtt段
    # 如果不同则调用：
    # - sync_to_global_config()
}
```

**步骤4: 重启服务应用配置**
```bash
# 如果本地服务配置有更新，重启mosquitto服务
if [ "$SERVICE_CONFIG_UPDATED" = true ]; then
    bash stop.sh && sleep 5 && bash start.sh
fi
```

### 3.5 配置更新函数详解

#### 3.5.1 核心配置管理函数 (缺失，需要补充实现)
```bash
# 从serviceupdate.json读取配置
read_config_from_serviceupdate() {
    if [ ! -f "$SERVICEUPDATE_FILE" ]; then
        return 1
    fi
    
    CONFIG_PORT=$(jq -r ".services[] | select(.id==\"$SERVICE_ID\") | .config.port" "$SERVICEUPDATE_FILE")
    CONFIG_BIND_ADDRESS=$(jq -r ".services[] | select(.id==\"$SERVICE_ID\") | .config.bind_address" "$SERVICEUPDATE_FILE")
    CONFIG_USERNAME=$(jq -r ".services[] | select(.id==\"$SERVICE_ID\") | .config.username" "$SERVICEUPDATE_FILE")
    CONFIG_PASSWORD=$(jq -r ".services[] | select(.id==\"$SERVICE_ID\") | .config.password" "$SERVICEUPDATE_FILE")
    CONFIG_WEBSOCKET_PORT=$(jq -r ".services[] | select(.id==\"$SERVICE_ID\") | .config.websocket_port" "$SERVICEUPDATE_FILE")
    CONFIG_ALLOW_ANONYMOUS=$(jq -r ".services[] | select(.id==\"$SERVICE_ID\") | .config.allow_anonymous" "$SERVICEUPDATE_FILE")
    CONFIG_PERSISTENCE=$(jq -r ".services[] | select(.id==\"$SERVICE_ID\") | .config.persistence" "$SERVICEUPDATE_FILE")
    
    return 0
}

# 根据serviceupdate.json生成mosquitto.conf
generate_mosquitto_config_from_serviceupdate() {
    if ! read_config_from_serviceupdate; then
        return 1
    fi
    
    mkdir -p "$(dirname "$MOSQUITTO_CONF_FILE")"
    
    cat > "$MOSQUITTO_CONF_FILE" << EOF
# Mosquitto Configuration File
# Auto-generated from serviceupdate.json config

# Network Settings
port $CONFIG_PORT
bind_address $CONFIG_BIND_ADDRESS

# WebSocket Support
listener $CONFIG_WEBSOCKET_PORT
protocol websockets

# Authentication
allow_anonymous $CONFIG_ALLOW_ANONYMOUS
password_file $MOSQUITTO_PASSWD_FILE

# Persistence
persistence $CONFIG_PERSISTENCE
persistence_location $TERMUX_VAR_DIR/lib/mosquitto/

# Logging
log_dest file $MOSQUITTO_LOG_DIR/mosquitto.log
log_type error
log_type warning
log_type notice
log_type information
log_timestamp true

# Security
max_connections 100
max_inflight_messages 20
max_queued_messages 100

# Client settings
clientid_prefixes
persistent_client_expiration 1m
EOF
    
    return 0
}

# 根据serviceupdate.json更新用户密码
update_users_from_serviceupdate() {
    if ! read_config_from_serviceupdate; then
        return 1
    fi
    
    # 创建密码文件
    echo "$CONFIG_USERNAME:$CONFIG_PASSWORD" | mosquitto_passwd -c "$MOSQUITTO_PASSWD_FILE" "$CONFIG_USERNAME"
    chmod 600 "$MOSQUITTO_PASSWD_FILE"
    
    return 0
}

# 同步到全局配置
sync_to_global_config() {
    if ! read_config_from_serviceupdate; then
        return 1
    fi
    
    # 更新configuration.yaml中的mqtt配置
    # 注意：这里需要使用yq或其他YAML处理工具
    # 暂时使用sed进行简单替换
    sed -i "s/^[[:space:]]*host:[[:space:]].*/  host: $CONFIG_BIND_ADDRESS/" "$CONFIG_FILE"
    sed -i "s/^[[:space:]]*port:[[:space:]].*/  port: $CONFIG_PORT/" "$CONFIG_FILE"
    sed -i "s/^[[:space:]]*username:[[:space:]].*/  username: $CONFIG_USERNAME/" "$CONFIG_FILE"
    sed -i "s/^[[:space:]]*password:[[:space:]].*/  password: $CONFIG_PASSWORD/" "$CONFIG_FILE"
    
    return 0
}

# 检查配置变更
check_config_changes() {
    # 检查serviceupdate.json与本地配置是否一致
    if compare_serviceupdate_with_local_config; then
        return 0  # 有变更
    fi
    
    # 检查本地配置与全局配置是否一致
    if compare_local_with_global_config; then
        return 0  # 有变更
    fi
    
    return 1  # 无变更
}
```

## 4. 服务控制命令

### 4.1 isgservicemonitor 控制
- **启动服务**: `echo u > /data/data/com.termux/files/usr/var/service/mosquitto/supervise/control`
- **停止服务**: `echo d > /data/data/com.termux/files/usr/var/service/mosquitto/supervise/control`
- **禁用自启动**: `touch /data/data/com.termux/files/usr/var/service/mosquitto/down`
- **启用自启动**: `rm -f /data/data/com.termux/files/usr/var/service/mosquitto/down`

### 4.2 进程检测机制
- **端口检测**: `netstat -tnl | grep -E "(1883|9001)"`
- **进程名称验证**: 检查进程是否确实是 mosquitto
- **配置文件验证**: 使用 `mosquitto -c config -t` 验证配置有效性
- **PID 获取**: 通过端口反查进程ID并验证进程名

## 5. MQTT 状态上报

### 5.1 基础操作状态消息

| 脚本名称 | MQTT 主题 | 状态值 | 说明 |
|---------|----------|--------|------|
| `install.sh` | `isg/install/mosquitto/status` | `installing`, `installed`, `failed` | 安装进度和结果 |
| `start.sh` | `isg/run/mosquitto/status` | `starting`, `success`, `failed` | 启动状态，包含 down 文件移除信息 |
| `stop.sh` | `isg/run/mosquitto/status` | `stopping`, `success`, `failed` | 停止状态，包含 down 文件创建信息 |
| `status.sh` | `isg/status/mosquitto/status` | `running`, `starting`, `stopped` | 实时状态（包含 PID、运行时间、端口状态） |
| `backup.sh` | `isg/backup/mosquitto/status` | `backuping`, `success`, `skipped`, `failed` | 备份进度和结果 |
| `restore.sh` | `isg/restore/mosquitto/status` | `restoring`, `success`, `failed` | 还原进度和结果，支持多种还原方式 |
| `update.sh` | `isg/update/mosquitto/status` | `updating`, `success`, `failed` | 升级进度和结果 |
| `uninstall.sh` | `isg/install/mosquitto/status` | `uninstalling`, `uninstalled` | 卸载进度 |

### 5.2 autocheck综合状态消息

#### 5.2.1 综合状态消息格式
```json
{
  "status": "healthy",
  "run": "running",
  "config": {
    "port": "1883",
    "bind_address": "0.0.0.0",
    "allow_anonymous": "false",
    "persistence": "true",
    "log_dest": "file",
    "password_file": "/data/data/com.termux/files/usr/etc/mosquitto/passwd"
  },
  "install": "success",
  "backup": "success", 
  "restore": "success",
  "update": "success",
  "current_version": "2.0.18",
  "latest_version": "2.0.18",
  "update_info": "SUCCESS 2 hours ago (2.0.15 -> 2.0.18)",
  "message": "mosquitto running for 2 hours",
  "port_listening": true,
  "ws_port_listening": true,
  "config_valid": true,
  "timestamp": 1234567890
}
```

#### 5.2.2 性能监控消息
```json
{
  "cpu": "2.1",
  "mem": "4.5",
  "timestamp": 1234567890
}
```

#### 5.2.3 版本信息消息
```json
{
  "script_version": "1.0.0",
  "latest_script_version": "1.0.0",
  "mosquitto_version": "2.0.18",
  "latest_mosquitto_version": "2.0.18",
  "upgrade_dependencies": []
}
```

### 5.3 App触发的配置检测状态

| 触发方式 | 状态 | MQTT消息 | 说明 |
|---------|------|----------|------|
| `--check-config` | `config_checking` | `{"status":"config_checking","message":"app triggered configuration check"}` | App触发配置一致性检查 |
| 配置一致 | `config_consistent` | `{"status":"config_consistent","message":"configuration is up to date"}` | 配置检查完成，配置一致 |
| 配置不一致 | `config_inconsistent` | `{"status":"config_inconsistent","message":"configuration changes detected but not applied"}` | 配置检查完成，有不一致 |
| `--update-config` | `config_updating` | `{"status":"config_updating","message":"configuration changes detected, starting sync"}` | App触发配置更新 |
| 配置同步成功 | `config_updated` | `{"status":"config_updated","message":"configuration synchronized successfully"}` | 配置同步完成 |
| 配置无变更 | `config_unchanged` | `{"status":"config_unchanged","message":"no configuration changes detected"}` | 配置检查完成，无变更 |
| 配置同步失败 | `config_failed` | `{"status":"config_failed","message":"failed to sync global configuration"}` | 配置同步失败 |
| `--sync-config` | `config_syncing` | `{"status":"config_syncing","message":"force syncing configuration"}` | 强制同步配置 |
| 强制同步成功 | `config_synced` | `{"status":"config_synced","message":"configuration force synced successfully"}` | 强制同步完成 |

### 5.4 环境变量驱动的配置更新状态

| 触发方式 | 状态 | MQTT消息 | 说明 |
|---------|------|----------|------|
| 检测到环境变量 | `config_updating` | `{"status":"config_updating","message":"environment variables detected, updating configuration"}` | 检测到MQTT_USERNAME或MQTT_PASSWORD |
| 步骤1完成 | `config_updating` | `{"status":"config_updating","message":"serviceupdate.json updated successfully"}` | serviceupdate.json更新完成 |
| 步骤2完成 | `config_updating` | `{"status":"config_updating","message":"local service config updated"}` | 本地服务配置更新完成 |
| 步骤3完成 | `config_updating` | `{"status":"config_updating","message":"global configuration updated"}` | 全局配置更新完成 |
| 服务重启完成 | `config_updated` | `{"status":"config_updated","message":"configuration updated successfully from environment variables","service_restarted":true,"global_updated":true}` | 完整流程完成 |
| 配置更新失败 | `config_failed` | `{"status":"config_failed","message":"failed to update serviceupdate.json"}` | 任一步骤失败 |

### 5.5 支持的autocheck参数扩展

| 参数 | 功能 | 说明 |
|------|------|------|
| 无参数 | 正常健康检查 + 环境变量检测 | 如果检测到环境变量会自动执行配置更新 |
| `--check-config` | 仅检查配置一致性 | App触发的配置检查，不执行更新 |
| `--update-config` | 检测并同步配置变更 | App触发的配置更新 |
| `--sync-config` | 强制同步配置 | 强制从serviceupdate.json同步配置 |
| `--update-env-config` | 环境变量驱动的配置更新 | 直接执行环境变量配置更新流程 |
| `--help` | 显示帮助信息 | 显示所有可用参数和用法 |

## 6. 安装部署

### 6.1 系统环境准备
```bash
# 更新包管理器
pkg update

# 安装必要工具
pkg install -y jq netstat-openbsd
```

### 6.2 Mosquitto 环境安装
```bash
# 安装 Mosquitto
pkg install -y mosquitto

# 验证安装版本
mosquitto -h | grep 'version' | awk '{print $3}'
```

### 6.3 配置文件生成
```bash
# 创建配置目录
mkdir -p /data/data/com.termux/files/usr/etc/mosquitto
mkdir -p /data/data/com.termux/files/usr/var/log/mosquitto

# 生成配置文件和密码文件
# 基于 serviceupdate.json config 字段自动生成
```

### 6.4 服务注册
```bash
# 创建服务监控目录
mkdir -p "/data/data/com.termux/files/usr/var/service/mosquitto/"

# 创建运行脚本
cat > "/data/data/com.termux/files/usr/var/service/mosquitto/run" << 'EOF'
#!/data/data/com.termux/files/usr/bin/sh
exec mosquitto -c /data/data/com.termux/files/usr/etc/mosquitto/mosquitto.conf 2>&1
EOF

chmod +x /data/data/com.termux/files/usr/var/service/mosquitto/run

# 禁用自启动
touch /data/data/com.termux/files/usr/var/service/mosquitto/down
```

## 7. 升级维护

### 7.1 版本升级流程
```bash
# 读取升级依赖
UPGRADE_DEPS=$(jq -c ".services[] | select(.id==\"mosquitto\") | .upgrade_dependencies" serviceupdate.json)

# 安装升级依赖
for dep in $(echo "$UPGRADE_DEPS" | jq -r '.[]'); do
    pkg install -y "$dep"
done

# 更新包列表
pkg update

# 升级 Mosquitto
pkg upgrade mosquitto

# 验证新版本
mosquitto -h | grep 'version' | awk '{print $3}'
```

### 7.2 环境变量控制
```bash
# 升级时安装指定依赖
EXTRA_DEPS="some-package" bash update.sh

# 自定义备份保留数量
KEEP_BACKUPS="5" bash update.sh
```

### 7.3 配置管理
- **配置文件位置**: `/data/data/com.termux/files/usr/etc/mosquitto/mosquitto.conf`
- **密码文件位置**: `/data/data/com.termux/files/usr/etc/mosquitto/passwd`
- **备份存储位置**: `/sdcard/isgbackup/mosquitto/`
- **配置源**: serviceupdate.json config 字段

## 8. 服务集成架构

### 8.1 服务发现机制
```yaml
# configuration.yaml 提供全局 MQTT 服务信息
mqtt:
  host: 127.0.0.1
  port: 1883
  username: admin
  password: admin123
  websocket_port: 9001
  broker_service: mosquitto
  tls: false
  cert_path: ""
  keepalive: 30
  debug: false
```

### 8.2 其他服务集成方式
```bash
# 其他服务脚本中的标准用法
load_mqtt_conf() {
    MQTT_HOST=$(grep -Po '^[[:space:]]*host:[[:space:]]*\K.*' "$CONFIG_FILE" | head -n1)
    MQTT_PORT=$(grep -Po '^[[:space:]]*port:[[:space:]]*\K.*' "$CONFIG_FILE" | head -n1)
    MQTT_USER=$(grep -Po '^[[:space:]]*username:[[:space:]]*\K.*' "$CONFIG_FILE" | head -n1)
    MQTT_PASS=$(grep -Po '^[[:space:]]*password:[[:space:]]*\K.*' "$CONFIG_FILE" | head -n1)
}
```

### 8.3 配置变更传播机制
1. **配置源更新**: serviceupdate.json 中的 config 字段更新
2. **App触发同步**: App调用 `autocheck.sh --update-config`
3. **配置检测**: autocheck.sh检测到配置变更
4. **本地配置更新**: 更新 mosquitto.conf 和 passwd 文件
5. **全局配置更新**: 同步更新 configuration.yaml
6. **服务重启**: Mosquitto 服务重启以应用新配置
7. **依赖服务通知**: 其他服务检测到 MQTT 配置变更并重启

## 9. 监控告警

### 9.1 健康检查项目
- **进程监控**: PID 和运行时间检查
- **端口监控**: 1883 和 9001 端口监听状态
- **配置监控**: 配置文件语法有效性验证
- **配置同步检查**: App触发时检测 serviceupdate.json 与当前配置的一致性
- **配置按需更新**: App触发时执行配置同步更新
- **性能监控**: CPU 和内存使用率统计
- **自动恢复**: 服务异常时自动重启

### 9.2 状态检查机制
```bash
# 改进的状态检查函数已在 common_paths.sh 中实现
get_improved_run_status()      # 检查运行状态，区分 starting/stopping/running/stopped
get_improved_install_status()  # 检查安装状态，支持 installing/uninstalling 检测
get_improved_backup_status()   # 检查备份状态，支持 backuping 检测
get_improved_update_status()   # 检查更新状态，支持 updating 检测
get_improved_restore_status()  # 检查还原状态，支持 restoring 检测
```

### 9.3 版本管理
- **脚本版本**: 当前 v1.0.0
- **服务版本**: 动态获取当前安装版本
- **更新检查**: 对比最新可用版本
- **依赖管理**: 自动处理版本升级依赖
- **配置兼容性**: 确保配置格式在版本升级时的兼容性

## 10. 备份策略

### 10.1 备份内容
- **配置文件备份**: mosquitto.conf 和 passwd 文件
- **持久化数据备份**: 消息持久化数据
- **日志备份**: 最近3天的日志文件
- **serviceupdate配置备份**: 备份serviceupdate.json中的配置部分
- **备份信息文件**: 包含备份时间、版本、配置摘要等信息
- **自动清理**: 保留最近 3 个备份文件

### 10.2 还原策略

#### 10.2.1 还原方式支持
1. **最新备份还原**: 自动选择最新的备份文件
2. **指定文件还原**: 支持用户指定 tar.gz 文件
3. **ZIP文件还原**: 自动转换 ZIP 为 tar.gz 格式
4. **默认配置生成**: 无备份文件时自动生成默认配置

#### 10.2.2 还原命令
```bash
# 自动还原最新备份文件
bash restore.sh

# 指定特定备份文件还原
RESTORE_FILE="/sdcard/backup/my_mosquitto_config.tar.gz" bash restore.sh

# 指定 ZIP 格式备份文件（自动转换）
RESTORE_FILE="/sdcard/backup/mosquitto_backup.zip" bash restore.sh

# 使用外部备份文件
RESTORE_FILE="/storage/emulated/0/Download/mosquitto-backup.zip" bash restore.sh
```

#### 10.2.3 ZIP文件处理机制
```bash
# ZIP文件自动转换流程
1. 检测文件格式（.zip）
2. 解压到临时目录
3. 查找有效的mosquitto数据结构
4. 重新打包为标准tar.gz格式
5. 执行标准还原流程
6. 清理临时文件
```

### 10.3 错误处理
- **服务依赖**: 备份前检查服务状态
- **配置验证**: 生成配置前验证 mosquitto 可用性
- **端口冲突**: 检测端口占用情况
- **配置同步**: 确保 configuration.yaml 与服务配置一致性
- **状态上报**: 完整的 MQTT 状态上报机制

## 11. 文件结构

### 11.1 脚本目录结构
```
/data/data/com.termux/files/home/servicemanager/mosquitto/
├── common_paths.sh     # 统一路径定义和公共函数
├── install.sh          # 安装脚本
├── start.sh            # 启动脚本
├── stop.sh             # 停止脚本
├── status.sh           # 状态查询脚本（实际文件名为mosquitto.sh）
├── backup.sh           # 备份脚本
├── restore.sh          # 还原脚本
├── update.sh           # 升级脚本
├── uninstall.sh        # 卸载脚本
├── autocheck.sh        # 自检脚本
├── VERSION             # 版本信息
├── .disabled           # 禁用标志文件（可选）
├── .lock_autocheck     # 自检锁文件（运行时）
├── .lastcheck          # 上次检查时间
└── logs/               # 日志目录
    ├── install.log          # 安装日志
    ├── start.log            # 启动日志
    ├── stop.log             # 停止日志
    ├── status.log           # 状态查询日志
    ├── backup.log           # 备份日志
    ├── restore.log          # 还原日志
    ├── update.log           # 升级日志
    ├── uninstall.log        # 卸载日志
    └── autocheck.log        # 自检日志
```

### 11.2 备份目录结构
```
/sdcard/isgbackup/mosquitto/
├── .install_history                               # 安装历史记录
├── .update_history                                # 更新历史记录
├── mosquitto_backup_20250717-152030.tar.gz      # 自动备份文件
├── mosquitto_backup_20250717-151500.tar.gz      # （保留最新3个）
├── mosquitto_backup_20250717-150900.tar.gz
├── mosquitto_converted_20250717-160000.tar.gz   # ZIP转换的文件
├── mosquitto_final_backup_20250717-160000.conf  # 卸载前最终备份
└── mosquitto_passwd_backup_20250717-160000      # 密码文件备份
```

### 11.3 服务运行环境
```
Termux 环境内:
/data/data/com.termux/files/usr/etc/mosquitto/
├── mosquitto.conf      # 主配置文件
└── passwd              # 用户密码文件

/data/data/com.termux/files/usr/var/
├── service/mosquitto/  # 服务监控目录
│   ├── run            # 运行脚本
│   ├── down           # 禁用标志（可选）
│   └── supervise/     # 监控控制目录
│       └── control    # 控制文件
├── log/mosquitto/     # 日志目录
│   └── mosquitto.log  # 运行日志
├── lib/mosquitto/     # 持久化数据目录
└── run/
    └── mosquitto.pid  # PID文件
```

### 11.4 全局配置文件
```
/data/data/com.termux/files/home/servicemanager/
├── configuration.yaml  # 全局配置文件
├── serviceupdate.json  # 服务更新配置
└── mosquitto/          # mosquitto服务目录
```

## 12. 配置文件模板

### 12.1 默认 mosquitto.conf
```conf
# Mosquitto Configuration File
# Auto-generated from serviceupdate.json config

# Network Settings
port 1883
bind_address 0.0.0.0

# WebSocket Support
listener 9001
protocol websockets

# Authentication
allow_anonymous false
password_file /data/data/com.termux/files/usr/etc/mosquitto/passwd

# Persistence
persistence true
persistence_location /data/data/com.termux/files/usr/var/lib/mosquitto/

# Logging
log_dest file /data/data/com.termux/files/usr/var/log/mosquitto/mosquitto.log
log_type error
log_type warning
log_type notice
log_type information
log_timestamp true

# Security
max_connections 100
max_inflight_messages 20
max_queued_messages 100

# Client settings
clientid_prefixes
persistent_client_expiration 1m
```

### 12.2 服务运行脚本
```bash
#!/data/data/com.termux/files/usr/bin/sh
exec mosquitto -c /data/data/com.termux/files/usr/etc/mosquitto/mosquitto.conf 2>&1
```

### 12.3 备份信息文件模板
```
Mosquitto Backup Information
============================
Backup Date: 2025-07-17 15:20:30
Mosquitto Version: 2.0.18
Service Status: {"status":"running","pid":1234,"runtime":"2:15:30"}
Backup Script Version: 1.0.0

Files Included:
- mosquitto.conf: Yes
- passwd: Yes
- persistence/: Yes
- logs/: Yes
- serviceupdate_config.json: Yes

Configuration Summary:
{"port":"1883","bind_address":"0.0.0.0","allow_anonymous":"false"}

ServiceUpdate Config:
{"port":"1883","bind_address":"0.0.0.0","username":"admin","password":"admin123"}
```

## 13. 故障排查

### 13.1 常见问题与解决方案

#### 13.1.1 服务启动问题
| 问题 | 可能原因 | 解决方案 |
|------|---------|----------|
| 服务无法启动 | 配置文件语法错误 | `mosquitto -c config -t` 验证配置 |
| 端口绑定失败 | 1883/9001端口被占用 | `netstat -tnlp \| grep -E "(1883\|9001)"` 检查端口 |
| 认证失败 | 密码文件权限或格式错误 | 检查passwd文件权限(600)和格式 |
| 配置文件不存在 | 安装不完整 | 运行 `bash restore.sh` 重新生成配置 |

#### 13.1.2 配置同步问题
| 问题 | 可能原因 | 解决方案 |
|------|---------|----------|
| 配置不一致 | serviceupdate.json与本地配置不同步 | `bash autocheck.sh --sync-config` |
| 环境变量不生效 | 环境变量格式错误 | 检查MQTT_USERNAME和MQTT_PASSWORD格式 |
| 全局配置未更新 | configuration.yaml写入权限问题 | 检查文件权限和磁盘空间 |

#### 13.1.3 备份还原问题
| 问题 | 可能原因 | 解决方案 |
|------|---------|----------|
| 备份失败 | 服务未运行 | 启动服务后重新备份 |
| ZIP文件还原失败 | ZIP文件结构不正确 | 检查ZIP文件是否包含mosquitto.conf |
| 还原后服务无法启动 | 配置文件损坏 | 删除配置文件重新运行restore.sh |

### 13.2 日志查看命令
```bash
# 查看服务状态
bash status.sh
bash status.sh --json    # JSON格式输出
bash status.sh --quiet   # 静默检查

# 查看详细日志
tail -f /data/data/com.termux/files/home/servicemanager/mosquitto/logs/autocheck.log

# 查看服务运行日志
tail -f /data/data/com.termux/files/usr/var/log/mosquitto/mosquitto.log

# 查看特定操作日志
tail -f /data/data/com.termux/files/home/servicemanager/mosquitto/logs/install.log
tail -f /data/data/com.termux/files/home/servicemanager/mosquitto/logs/backup.log
tail -f /data/data/com.termux/files/home/servicemanager/mosquitto/logs/restore.log

# 测试配置文件
mosquitto -c /data/data/com.termux/files/usr/etc/mosquitto/mosquitto.conf -t
```

### 13.3 手动操作命令
```bash
# 手动启动服务
bash start.sh

# 强制重启
bash stop.sh && sleep 5 && bash start.sh

# 重新生成配置
bash restore.sh

# 检查端口状态
netstat -tnlp | grep -E "(1883|9001)"

# 测试MQTT连接
mosquitto_pub -h 127.0.0.1 -p 1883 -u admin -P admin -t test -m "hello"
mosquitto_sub -h 127.0.0.1 -p 1883 -u admin -P admin -t test

# 检查进程状态
ps aux | grep mosquitto
pgrep -f mosquitto

# 检查服务控制文件
ls -la /data/data/com.termux/files/usr/var/service/mosquitto/
cat /data/data/com.termux/files/usr/var/service/mosquitto/run
```

### 13.4 配置验证命令
```bash
# 验证serviceupdate.json格式
jq . /data/data/com.termux/files/home/servicemanager/serviceupdate.json

# 检查配置一致性
bash autocheck.sh --check-config

# 强制同步配置
bash autocheck.sh --sync-config

# 环境变量配置更新
MQTT_USERNAME="newuser" MQTT_PASSWORD="newpass" bash autocheck.sh --update-env-config
```

## 14. 环境变量参考

### 14.1 配置管理环境变量
| 变量名称 | 默认值 | 说明 | 示例 |
|---------|-------|------|------|
| `MQTT_USERNAME` | - | 新的MQTT用户名（触发配置更新） | `MQTT_USERNAME="newuser" bash autocheck.sh` |
| `MQTT_PASSWORD` | - | 新的MQTT密码（触发配置更新） | `MQTT_PASSWORD="newpass" bash autocheck.sh` |

### 14.2 升级脚本环境变量
| 变量名称 | 默认值 | 说明 | 示例 |
|---------|-------|------|------|
| `UPGRADE_DEPS` | 从serviceupdate.json读取 | 升级依赖包列表 | 自动从配置文件读取 |

### 14.3 还原脚本环境变量
| 变量名称 | 默认值 | 说明 | 示例 |
|---------|-------|------|------|
| `RESTORE_FILE` | - | 指定要还原的备份文件路径 | `RESTORE_FILE="/sdcard/backup/config.zip" bash restore.sh` |

### 14.4 通用环境变量
| 变量名称 | 默认值 | 说明 | 示例 |
|---------|-------|------|------|
| `BACKUP_DIR` | `/sdcard/isgbackup/mosquitto` | 备份文件存储目录 | `BACKUP_DIR="/storage/backups" bash backup.sh` |
| `KEEP_BACKUPS` | `3` | 保留的备份文件数量 | `KEEP_BACKUPS="5" bash backup.sh` |
| `MAX_TRIES` | `30` | 最大重试次数 | `MAX_TRIES="60" bash start.sh` |
| `RETRY_INTERVAL` | `60` | 重试间隔（秒） | `RETRY_INTERVAL="30" bash autocheck.sh` |
| `MAX_WAIT` | `300` | 最大等待时间（秒） | `MAX_WAIT="600" bash start.sh` |

## 15. 历史记录文件

### 15.1 文件位置与权限
- **安装历史**: `/sdcard/isgbackup/mosquitto/.install_history`
- **更新历史**: `/sdcard/isgbackup/mosquitto/.update_history`
- **文件权限**: 644 (用户读写，组和其他用户只读)
- **存储位置**: 外部存储，持久化保存

### 15.2 记录格式详解

#### 15.2.1 安装历史记录
```
2025-07-17 15:30:15 INSTALL SUCCESS 2.0.18
2025-07-17 16:45:22 UNINSTALL SUCCESS
2025-07-17 09:15:30 INSTALL FAILED unknown
```

**字段说明**:
- 时间戳: `YYYY-MM-DD HH:MM:SS`
- 操作类型: `INSTALL` | `UNINSTALL`
- 状态: `SUCCESS` | `FAILED`
- 版本: 安装的版本号或 `unknown`

#### 15.2.2 更新历史记录
```
2025-07-17 17:30:15 SUCCESS 2.0.15 -> 2.0.18
2025-07-17 18:45:22 FAILED 2.0.15 -> 2.0.18 (service start timeout)
2025-07-17 10:20:10 SUCCESS 2.0.15 -> 2.0.18
```

**字段说明**:
- 时间戳: `YYYY-MM-DD HH:MM:SS`
- 状态: `SUCCESS` | `FAILED`
- 版本变迁: `old_version -> new_version`
- 失败原因: 括号内描述具体原因（仅失败时）

### 15.3 历史记录函数实现
```bash
# 记录安装历史
record_install_history() {
    local status="$1"
    local version="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "$timestamp INSTALL $status $version" >> "$INSTALL_HISTORY_FILE"
}

# 记录卸载历史
record_uninstall_history() {
    local status="$1"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "$timestamp UNINSTALL $status" >> "$INSTALL_HISTORY_FILE"
}

# 记录更新历史
record_update_history() {
    local status="$1"
    local old_version="$2"
    local new_version="$3"
    local reason="$4"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    if [ "$status" = "SUCCESS" ]; then
        echo "$timestamp SUCCESS $old_version -> $new_version" >> "$UPDATE_HISTORY_FILE"
    else
        echo "$timestamp FAILED $old_version -> $new_version ($reason)" >> "$UPDATE_HISTORY_FILE"
    fi
}
```

## 16. 与 Zigbee2MQTT 的主要差异

### 16.1 架构差异
| 方面 | Mosquitto | Zigbee2MQTT |
|------|-----------|-------------|
| **运行环境** | 直接在 Termux 环境运行 | 需要 proot 容器环境 |
| **安装方式** | 使用 pkg 包管理器 | 源码编译安装 |
| **配置复杂度** | 配置文件简洁明了 | 复杂的设备检测和配置 |
| **资源占用** | 轻量级，低资源消耗 | 相对较重，需要更多资源 |

### 16.2 功能差异
| 功能 | Mosquitto | Zigbee2MQTT |
|------|-----------|-------------|
| **端口监控** | 同时监控 MQTT(1883) 和 WebSocket(9001) 端口 | 主要监控 MQTT 端口 |
| **配置验证** | 内置 `mosquitto -c config -t` 语法检查 | 复杂的 YAML 配置验证 |
| **用户管理** | 密码文件的创建和管理 | 依赖外部 MQTT broker |
| **设备检测** | 无需设备检测 | 需要检测串口 Zigbee 适配器 |
| **桥接状态** | 无桥接概念 | 复杂的桥接状态管理 |

### 16.3 监控差异
| 监控项目 | Mosquitto | Zigbee2MQTT |
|---------|-----------|-------------|
| **进程检测** | 通过端口反查PID | 通过proot进程检测 |
| **状态上报** | 简洁的状态信息 | 包含设备状态和桥接信息 |
| **性能监控** | CPU、内存使用率 | CPU、内存、设备连接数 |
| **错误恢复** | 简单的服务重启 | 复杂的设备重连和状态恢复 |

### 16.4 配置管理差异
| 配置方面 | Mosquitto | Zigbee2MQTT |
|---------|-----------|-------------|
| **配置文件** | 单一 mosquitto.conf | 多个配置文件 (configuration.yaml等) |
| **配置更新** | 环境变量驱动更新 | 文件监控驱动更新 |
| **配置验证** | 内置语法检查 | 运行时配置验证 |
| **默认配置** | 自动生成简洁配置 | 复杂的默认配置模板 |

## 17. 性能优化建议

### 17.1 启动优化
```bash
# 优化启动等待逻辑
MAX_TRIES=30          # 减少重试次数
RETRY_INTERVAL=5      # 缩短重试间隔
INTERVAL=2            # 缩短检查间隔
```

### 17.2 监控优化
```bash
# 优化autocheck执行频率
# 建议通过cron或定时任务每5-10分钟执行一次
*/5 * * * * bash /data/data/com.termux/files/home/servicemanager/mosquitto/autocheck.sh
```

### 17.3 日志优化
```bash
# 在autocheck.sh中实现的日志清理函数
trim_log() {
    tail -n 500 "$LOG_FILE" > "$LOG_FILE.tmp" && mv "$LOG_FILE.tmp" "$LOG_FILE"
}
```

### 17.4 备份优化
```bash
# 自动清理旧备份，保留最近N个
KEEP_BACKUPS=3  # 可通过环境变量调整
```

## 18. 安全考虑

### 18.1 密码文件安全
```bash
# 密码文件权限设置
chmod 600 "$MOSQUITTO_PASSWD_FILE"

# 避免在日志中记录敏感信息
# autocheck.sh 状态消息中不包含密码信息
```

### 18.2 配置文件保护
```bash
# 配置文件备份加密（可选）
# 未来可考虑对备份文件进行加密
```

### 18.3 网络安全
```bash
# 默认配置禁用匿名访问
allow_anonymous false

# 支持TLS配置（预留）
# 在configuration.yaml中预留tls配置选项
```

## 19. 扩展性设计

### 19.1 插件化配置
- **预留配置字段**: serviceupdate.json 中可扩展更多配置选项
- **模块化函数**: common_paths.sh 中的函数可被其他服务复用
- **标准化接口**: MQTT 消息格式可被其他服务参考

### 19.2 多服务协调
- **依赖关系管理**: 可扩展支持服务间依赖关系
- **配置联动**: 一个服务的配置变更可触发相关服务更新
- **状态聚合**: 可实现多服务状态的聚合上报

### 19.3 监控扩展
- **自定义指标**: 可扩展更多监控指标
- **告警规则**: 可实现基于阈值的自动告警
- **趋势分析**: 可扩展性能数据的趋势分析

## 20. 版本升级路径

### 20.1 脚本版本升级
```bash
# 脚本版本升级流程
1. 下载新版本脚本包
2. 备份当前版本
3. 解压新版本到临时目录
4. 验证新版本兼容性
5. 替换脚本文件
6. 更新VERSION文件
7. 执行兼容性检查
```

### 20.2 配置兼容性
- **向后兼容**: 新版本配置兼容旧版本
- **配置迁移**: 自动处理配置格式变更
- **回滚机制**: 升级失败时可回滚到原版本

### 20.3 数据迁移
- **持久化数据**: 保持消息持久化数据的兼容性
- **日志格式**: 保持日志格式的一致性
- **历史记录**: 保持历史记录的连续性

---

**文档维护说明**:
- 本文档应随脚本版本更新而更新
- 新增功能需要相应更新文档
- 配置变更需要更新相应章节
- 定期检查文档与实际实现的一致性