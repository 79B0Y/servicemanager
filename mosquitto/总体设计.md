**文档版本**: v1.0.0  
**最后更新**: 2025-07-16  
**维护者**: LinknLink 技术团队

# Mosquitto 服务管理系统设计文档

## 1. 服务标识
**Service ID**: `mosquitto`

## 2. 脚本功能概览

| 脚本名称 | 主要功能 | 描述 |
|---------|---------|------|
| `install.sh` | 安装 Mosquitto 服务 | 在 Termux 环境中安装 Mosquitto、生成配置文件、创建用户密码 |
| `start.sh` | 启动服务 | 通过 isgservicemonitor 控制文件启动 Mosquitto 服务，同时启用服务自启动，移除 down 文件 rm -f "/data/data/com.termux/files/usr/var/service/mosquitto/down" |
| `stop.sh` | 停止服务 | 停止 Mosquitto 服务，创建 `.disabled` 标志文件。同时关闭服务自启动，创建 down 文件 touch "/data/data/com.termux/files/usr/var/service/mosquitto/down" |
| `status.sh` | 状态查询 | 通过进程 PID 和端口 1883、9001 检查服务状态，验证配置文件有效性 |
| `backup.sh` | 配置备份 | 备份配置文件、密码文件、持久化数据到 `/sdcard/isgbackup/mosquitto/` |
| `restore.sh` | 配置还原 | 还原备份文件或自动生成默认配置文件 |
| `update.sh` | 服务升级 | 升级 Mosquitto 到最新版本 |
| `uninstall.sh` | 卸载服务 | 完全卸载 Mosquitto 环境和配置 |
| `autocheck.sh` | 自检监控 | 单服务自检、性能监控和健康检查 |

## 3. MQTT 状态上报

| 脚本名称 | MQTT 主题 | 状态值 | 说明 |
|---------|----------|--------|------|
| `install.sh` | `isg/install/mosquitto/status` | `installing`, `installed`, `failed` | 安装进度和结果 |
| `start.sh` | `isg/run/mosquitto/status` | `starting`, `success`, `failed` | 启动状态，包含 down 文件移除信息 "message":"removed down file to enable auto-start"|
| `stop.sh` | `isg/run/mosquitto/status` | `stopping`, `success`, `failed` | 停止状态，包含 down 文件创建信息 "message":"created down file to disable auto-start"|
| `status.sh` | `isg/status/mosquitto/status` | `running`, `starting`, `stopped` | 实时状态（包含 PID、运行时间、端口状态） |
| `backup.sh` | `isg/backup/mosquitto/status` | `backuping`, `success`, `skipped`, `failed` | 备份进度和结果 |
| `restore.sh` | `isg/restore/mosquitto/status` | `restoring`, `success`, `failed`, `skipped` | 还原进度和结果 |
| `update.sh` | `isg/update/mosquitto/status` | `updating`, `success`, `failed` | 升级进度和结果 |
| `uninstall.sh` | `isg/install/mosquitto/status` | `uninstalling`, `uninstalled` | 卸载进度 |
| `autocheck.sh` | `isg/autocheck/mosquitto/status` | { "status":"start/ healthy/ problem", "run":"running / stopped","config":{ "port": "1883","bind_address": "0.0.0.0","allow_anonymous": "false","password_file": "/data/data/com.termux/files/usr/etc/mosquitto/passwd","log_dest": "file","persistence": "true" },"install":"installed / uninstalled / installing","current_version":"2.0.18","latest_version":"2.0.18","update":"updated on 2025-07-16","message":"mosquitto running for xx hours","port_listening":true,"ws_port_listening":true,"config_valid":true} | 自检状态 |
| `autocheck.sh` | `isg/autocheck/mosquitto/performance` | - | 性能数据（CPU、内存使用率） |
| `autocheck.sh` | `isg/autocheck/mosquitto/version` | - | 版本信息（脚本版本、服务版本） |

## 4. 服务控制命令

### 4.1 isgservicemonitor 控制
- **启动服务**: `echo u > /data/data/com.termux/files/usr/var/service/mosquitto/supervise/control`
- **停止服务**: `echo d > /data/data/com.termux/files/usr/var/service/mosquitto/supervise/control`
- **禁用自启动**: `touch /data/data/com.termux/files/usr/var/service/mosquitto/down`
- **启用自启动**: `rm -f /data/data/com.termux/files/usr/var/service/mosquitto/down`

### 4.2 进程检测机制
- 通过 1883 端口检测: `netstat -tnlp | grep 1883`
- 通过 9001 端口检测: `netstat -tnlp | grep 9001`
- 进程名称验证: 检查进程是否确实是 mosquitto
- 配置文件验证: 使用 `mosquitto -c config -t` 验证配置有效性

## 5. 安装部署

### 5.1 系统环境准备
```bash
# 更新包管理器
pkg update
```

### 5.2 Mosquitto 环境安装
```bash
# 安装 Mosquitto
pkg install -y mosquitto

# 验证安装版本
mosquitto -h | grep 'version' | awk '{print $3}'
```

### 5.3 配置文件生成
```bash
# 创建配置目录
mkdir -p /data/data/com.termux/files/usr/etc/mosquitto

# 生成配置文件和密码文件
# 基于 servicemanager/configuration.yaml 中的 MQTT 配置自动生成
```

### 5.4 服务注册
```bash
# 创建服务监控目录
mkdir -p "/data/data/com.termux/files/usr/var/service/mosquitto/"

# 创建运行脚本
echo '#!/data/data/com.termux/files/usr/bin/sh
exec mosquitto -c /data/data/com.termux/files/usr/etc/mosquitto/mosquitto.conf 2>&1' > "/data/data/com.termux/files/usr/var/service/mosquitto/run"

chmod +x /data/data/com.termux/files/usr/var/service/mosquitto/run

# 禁用自启动
touch /data/data/com.termux/files/usr/var/service/mosquitto/down
```

## 6. 升级维护

### 6.1 版本升级流程
```bash
# 更新包列表
pkg update

# 升级 Mosquitto
pkg upgrade mosquitto

# 验证新版本
mosquitto -h | grep 'version' | awk '{print $3}'
```

### 6.2 环境变量控制
```bash
# 升级时安装指定依赖
EXTRA_DEPS="some-package" bash update.sh

# 自定义备份保留数量
KEEP_BACKUPS="5" bash update.sh
```

### 6.3 配置管理
- **配置文件位置**: `/data/data/com.termux/files/usr/etc/mosquitto/mosquitto.conf`
- **密码文件位置**: `/data/data/com.termux/files/usr/etc/mosquitto/passwd`
- **备份存储位置**: `/sdcard/isgbackup/mosquitto/`
- **默认配置生成**: 基于 servicemanager 配置自动生成

## 7. 特殊功能

### 7.1 配置文件自动生成
- **基础配置**: 端口、绑定地址、认证设置
- **WebSocket支持**: 9001端口WebSocket监听
- **持久化配置**: 消息持久化和客户端会话
- **日志配置**: 文件日志和日志级别
- **安全设置**: 最大连接数、消息队列限制

### 7.2 用户管理
- **自动用户创建**: 基于 servicemanager 配置创建管理员用户
- **密码加密**: 使用 mosquitto_passwd 工具加密存储
- **权限控制**: 禁用匿名访问，强制用户认证

### 7.3 备份策略
- **配置文件备份**: mosquitto.conf 和 passwd 文件
- **持久化数据备份**: 消息持久化数据
- **日志备份**: 最近3天的日志文件
- **自动清理**: 保留最近 3 个备份文件
- **格式支持**: tar.gz 和 zip 格式
- **智能转换**: ZIP 文件自动转换为标准 tar.gz 格式

### 7.4 还原控制
```bash
# 自动还原最新备份文件
bash restore.sh

# 指定特定备份文件还原
RESTORE_FILE="/sdcard/backup/my_mosquitto_config.tar.gz" bash restore.sh

# 指定 ZIP 格式备份文件（自动转换）
RESTORE_FILE="/sdcard/backup/mosquitto_backup.zip" bash restore.sh

# 使用外部备份文件
RESTORE_FILE="/storage/emulated/0/Download/mosquitto-backup.zip" bash restore.sh
```

### 7.5 错误处理
- **服务依赖**: 备份前检查服务状态
- **配置验证**: 生成配置前验证 mosquitto 可用性
- **端口冲突**: 检测端口占用情况
- **状态上报**: 完整的 MQTT 状态上报机制

## 8. 监控告警

### 8.1 健康检查
- **进程监控**: PID 和运行时间检查
- **端口监控**: 1883 和 9001 端口监听状态
- **配置监控**: 配置文件语法有效性验证
- **性能监控**: CPU 和内存使用率统计
- **自动恢复**: 服务异常时自动重启

### 8.2 版本管理
- **脚本版本**: 当前 v1.0.0
- **服务版本**: 动态获取当前安装版本
- **更新检查**: 对比最新可用版本
- **依赖管理**: 自动处理版本升级依赖

## 9. 文件结构

### 9.1 脚本目录结构
```
/data/data/com.termux/files/home/servicemanager/mosquitto/
├── install.sh          # 安装脚本
├── start.sh            # 启动脚本
├── stop.sh             # 停止脚本
├── status.sh           # 状态查询脚本
├── backup.sh           # 备份脚本
├── restore.sh          # 还原脚本
├── update.sh           # 升级脚本
├── uninstall.sh        # 卸载脚本
├── autocheck.sh        # 自检脚本
├── common_paths.sh     # 统一路径定义
├── VERSION             # 版本信息
└── logs/               # 日志目录
    ├── install.log          # 安装日志
    ├── start.log            # 启动日志
    ├── stop.log             # 停止日志
    ├── status.log           # 状态查询日志
    ├── backup.log           # 备份日志
    ├── restore.log          # 还原日志
    ├── update.log           # 升级日志
    ├── uninstall.log        # 卸载日志
    └── autocheck.log        # 自检日志
```

### 9.2 备份目录结构
```
/sdcard/isgbackup/mosquitto/
├── .install_history                               # 安装历史记录
├── .update_history                                # 更新历史记录
├── mosquitto_backup_20250716-152030.tar.gz      # 自动备份文件
├── mosquitto_backup_20250716-151500.tar.gz      # （保留最新3个）
├── mosquitto_backup_20250716-150900.tar.gz
├── mosquitto_final_backup_20250716-160000.conf  # 卸载前最终备份
└── mosquitto_passwd_backup_20250716-160000      # 密码文件备份
```

### 9.3 服务运行环境
```
Termux 环境内:
/data/data/com.termux/files/usr/etc/mosquitto/
├── mosquitto.conf      # 主配置文件
└── passwd              # 用户密码文件

/data/data/com.termux/files/usr/var/
├── service/mosquitto/  # 服务监控目录
│   ├── run            # 运行脚本
│   ├── down           # 禁用标志（可选）
│   └── supervise/     # 监控控制目录
├── log/mosquitto/     # 日志目录
│   └── mosquitto.log  # 运行日志
├── lib/mosquitto/     # 持久化数据目录
└── run/
    └── mosquitto.pid  # PID文件
```

## 10. 故障排查

### 10.1 常见问题
- **服务无法启动**: 检查配置文件语法和端口占用
- **端口冲突**: 检查 1883 和 9001 端口是否被占用
- **认证失败**: 检查密码文件权限和用户配置
- **配置文件损坏**: 使用 restore.sh 重新生成配置

### 10.2 日志查看
```bash
# 查看服务状态
bash status.sh

# 查看详细日志
tail -f /data/data/com.termux/files/home/servicemanager/mosquitto/logs/autocheck.log

# 查看服务运行日志
tail -f /data/data/com.termux/files/usr/var/log/mosquitto/mosquitto.log

# 测试配置文件
mosquitto -c /data/data/com.termux/files/usr/etc/mosquitto/mosquitto.conf -t
```

### 10.3 手动操作
```bash
# 手动启动服务
bash start.sh

# 强制重启
bash stop.sh && sleep 5 && bash start.sh

# 重新生成配置
bash restore.sh

# 检查端口状态
netstat -tnlp | grep -E "(1883|9001)"

# 测试MQTT连接
mosquitto_pub -h 127.0.0.1 -p 1883 -u admin -P admin -t test -m "hello"
mosquitto_sub -h 127.0.0.1 -p 1883 -u admin -P admin -t test
```

## 11. 环境变量参考

### 11.1 安装脚本环境变量

| 变量名称 | 默认值 | 说明 | 示例 |
|---------|-------|------|------|
| 无特定环境变量 | - | 安装脚本使用固定配置 | - |

### 11.2 升级脚本环境变量

| 变量名称 | 默认值 | 说明 | 示例 |
|---------|-------|------|------|
| `EXTRA_DEPS` | - | 升级时安装的额外依赖包 | `EXTRA_DEPS="some-package" bash update.sh` |

### 11.3 还原脚本环境变量

| 变量名称 | 默认值 | 说明 | 示例 |
|---------|-------|------|------|
| `RESTORE_FILE` | - | 指定要还原的备份文件路径 | `RESTORE_FILE="/sdcard/backup/config.zip" bash restore.sh` |

### 11.4 通用环境变量

| 变量名称 | 默认值 | 说明 | 示例 |
|---------|-------|------|------|
| `BACKUP_DIR` | `/sdcard/isgbackup/mosquitto` | 备份文件存储目录 | `BACKUP_DIR="/storage/backups" bash backup.sh` |
| `KEEP_BACKUPS` | `3` | 保留的备份文件数量 | `KEEP_BACKUPS="5" bash backup.sh` |

### 11.5 使用示例

#### 从指定文件还原配置
```bash
RESTORE_FILE="/sdcard/Download/mosquitto_backup_20250716.zip" bash restore.sh
```

#### 自定义备份目录和保留数量
```bash
BACKUP_DIR="/storage/external/mosquitto_backups" KEEP_BACKUPS="5" bash backup.sh
```

#### 升级时安装额外依赖
```bash
EXTRA_DEPS="libssl-dev" bash update.sh
```

## 12. 历史记录文件

### 12.1 文件位置
- **安装历史**: `/sdcard/isgbackup/mosquitto/.install_history`
- **更新历史**: `/sdcard/isgbackup/mosquitto/.update_history`

### 12.2 记录格式

#### 安装历史记录
```
2025-07-16 15:30:15 INSTALL SUCCESS 2.0.18
2025-07-16 16:45:22 UNINSTALL SUCCESS
2025-07-16 09:15:30 INSTALL SUCCESS 2.0.18
```

#### 更新历史记录
```
2025-07-16 17:30:15 SUCCESS 2.0.15 -> 2.0.18
2025-07-16 18:45:22 FAILED 2.0.15 -> 2.0.18 (service start timeout)
2025-07-16 10:20:10 SUCCESS 2.0.15 -> 2.0.18
```

### 12.3 记录规则
- **时间格式**: `YYYY-MM-DD HH:MM:SS`
- **状态类型**: `INSTALL SUCCESS` / `UNINSTALL SUCCESS` / `SUCCESS` / `FAILED`
- **版本信息**: 安装记录单版本，更新记录版本变迁
- **失败原因**: 更新失败时包含具体原因
- **文件权限**: 存储在 `/sdcard` 目录，持久化保存

## 13. 配置文件模板

### 13.1 默认 mosquitto.conf
```conf
# Mosquitto Configuration File
# Auto-generated by servicemanager

# Network Settings
port 1883
bind_address 0.0.0.0

# WebSocket Support
listener 9001
protocol websockets

# Authentication
allow_anonymous false
password_file /data/data/com.termux/files/usr/etc/mosquitto/passwd

# Persistence
persistence true
persistence_location /data/data/com.termux/files/usr/var/lib/mosquitto/

# Logging
log_dest file /data/data/com.termux/files/usr/var/log/mosquitto/mosquitto.log
log_type error
log_type warning
log_type notice
log_type information
log_timestamp true

# Security
max_connections 100
max_inflight_messages 20
max_queued_messages 100

# Client settings
clientid_prefixes
persistent_client_expiration 1m
```

### 13.2 服务运行脚本
```bash
#!/data/data/com.termux/files/usr/bin/sh
exec mosquitto -c /data/data/com.termux/files/usr/etc/mosquitto/mosquitto.conf 2>&1
```

## 14. 性能指标

### 14.1 资源占用
- **内存使用**: 通常 < 10MB
- **CPU使用**: 通常 < 2%
- **磁盘空间**: 配置文件 < 1KB，持久化数据根据消息量变化

### 14.2 性能监控
- **连接数监控**: 当前活跃连接数
- **消息吞吐量**: 每秒处理的消息数
- **持久化性能**: 消息持久化延迟
- **WebSocket连接**: WebSocket客户端数量

## 15. 安全考虑

### 15.1 认证安全
- **强制认证**: 禁用匿名访问
- **密码加密**: 使用 mosquitto_passwd 加密存储
- **文件权限**: 密码文件设置为 600 权限

### 15.2 网络安全
- **绑定地址**: 可配置绑定特定地址
- **连接限制**: 限制最大连接数和消息队列
- **日志记录**: 记录连接和认证事件

### 15.3 数据安全
- **备份加密**: 建议对敏感备份文件进行加密
- **传输安全**: 支持TLS配置（需要证书）
- **访问控制**: 基于用户的主题访问控制

---

## 16. 与 Zigbee2MQTT 的主要差异

### 16.1 架构差异
- **运行环境**: 直接在 Termux 环境运行，无需 proot 容器
- **安装方式**: 使用 pkg 包管理器，更简单直接
- **配置管理**: 配置文件更简洁，无需复杂的设备检测

### 16.2 功能差异
- **端口监控**: 同时监控 MQTT 和 WebSocket 端口
- **配置验证**: 内置配置文件语法检查
- **用户管理**: 密码文件的创建和管理

### 16.3 监控差异
- **桥接状态**: 无需检查复杂的桥接状态
- **设备检测**: 无需串口设备检测
- **资源消耗**: 更轻量级的资源占用

---